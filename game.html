<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeStitcher | Neural Simulation</title>
    <link rel="icon" type="image/png" href="codestitcher.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 1. LIBRARIES (MOVED TO HEAD FOR STABILITY) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>
    
    <!-- 2. FIREBASE LIBRARIES (MOVED TO HEAD TO FIX "UNDEFINED" ERROR) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #04050a;
            --surface: #080c14;
            --surface2: #0d1220;
            --border: rgba(0,240,255,0.08);
            --border-bright: rgba(0,240,255,0.25);
            --cyan: #00F0FF;
            --cyan-dim: rgba(0,240,255,0.15);
            --gold: #FFD43B;
            --gold-dim: rgba(255,212,59,0.15);
            --green: #00D26A;
            --green-dim: rgba(0,210,106,0.15);
            --red: #FF3860;
            --red-dim: rgba(255,56,96,0.15);
            --purple: #7C5CBF;
            --text: #e0e8f0;
            --text-dim: #4a5568;
            --font-mono: 'JetBrains Mono', monospace;
            --font-ui: 'Outfit', sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ─── CANVAS BACKGROUND ─── */
        #bg-canvas {
            position: fixed; inset: 0; z-index: 0;
            pointer-events: none;
        }

        /* ─── NAV ─── */
        nav {
            position: relative; z-index: 100;
            height: 58px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: rgba(4,5,10,0.96);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            flex-shrink: 0;
        }

        .nav-left { display: flex; align-items: center; gap: 16px; }
        .nav-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .nav-logo img { height: 36px; width: auto; }
        .nav-title { font-weight: 800; font-size: 1.1rem; color: white; letter-spacing: -0.3px; }
        .nav-tag {
            font-family: var(--font-mono); font-size: 0.7rem;
            color: var(--cyan); background: var(--cyan-dim);
            border: 1px solid rgba(0,240,255,0.2);
            padding: 2px 7px; border-radius: 3px; letter-spacing: 1px;
        }

        /* ─── XP BAR AREA ─── */
        .xp-area {
            display: flex; align-items: center; gap: 12px;
            flex: 1; max-width: 320px; margin: 0 30px;
        }
        .xp-label {
            font-family: var(--font-mono); font-size: 0.7rem; color: var(--gold);
            white-space: nowrap; letter-spacing: 1px;
        }
        .xp-track {
            flex: 1; height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px; overflow: hidden;
        }
        .xp-fill {
            height: 100%; background: linear-gradient(90deg, var(--gold), #ff9900);
            border-radius: 2px;
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            width: 0%;
            box-shadow: 0 0 8px rgba(255,212,59,0.5);
        }
        .rank-badge {
            font-family: var(--font-mono); font-size: 0.65rem;
            color: var(--gold); background: var(--gold-dim);
            border: 1px solid rgba(255,212,59,0.2);
            padding: 3px 8px; border-radius: 3px; white-space: nowrap;
            letter-spacing: 1px;
        }

        .nav-right { display: flex; gap: 8px; align-items: center; }
        .nav-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 14px; border-radius: 5px;
            font-size: 0.8rem; font-weight: 600; font-family: var(--font-ui);
            text-decoration: none; border: 1px solid transparent;
            cursor: pointer; transition: all 0.25s ease;
        }
        .btn-home { color: #8899aa; border-color: rgba(255,255,255,0.07); background: rgba(255,255,255,0.03); }
        .btn-home:hover { color: white; border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
        .btn-exit { color: var(--red); border-color: rgba(255,56,96,0.2); background: var(--red-dim); }
        .btn-exit:hover { background: var(--red); color: white; box-shadow: 0 0 20px rgba(255,56,96,0.4); }

        /* User Profile Area in Nav */
        .user-profile { display: none; align-items: center; gap: 10px; margin-right: 15px; }
        .user-email { font-size: 0.75rem; color: var(--cyan); font-family: var(--font-mono); }
        .btn-auth {
            background: rgba(0,240,255,0.1); border: 1px solid var(--cyan); color: var(--cyan);
            padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: var(--font-mono); font-size: 0.75rem;
            transition: 0.2s;
        }
        .btn-auth:hover { background: var(--cyan); color: #000; box-shadow: 0 0 10px var(--cyan); }

        /* ─── MAIN LAYOUT ─── */
        #app {
            flex: 1; display: flex;
            position: relative; z-index: 10;
            overflow: hidden;
        }

        /* ─── LEFT SIDE ─── */
        .left-panel {
            display: flex; flex-direction: column;
            width: 50%; border-right: 1px solid var(--border);
            position: relative;
        }

        /* ─── LEVEL HEADER ─── */
        .level-header {
            padding: 10px 20px;
            background: rgba(8,12,20,0.9);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .level-info { display: flex; align-items: center; gap: 12px; }
        .level-num {
            font-family: var(--font-mono); font-size: 0.7rem;
            color: var(--cyan); background: var(--cyan-dim);
            border: 1px solid rgba(0,240,255,0.2);
            padding: 3px 8px; border-radius: 3px; letter-spacing: 1px;
        }
        .level-name { font-weight: 700; font-size: 0.95rem; color: white; }
        .level-story { font-size: 0.75rem; color: #5a6880; max-width: 300px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }

        .stars-display { display: flex; gap: 4px; }
        .star { font-size: 1rem; color: #2a3040; transition: all 0.3s ease; }
        .star.earned { color: var(--gold); text-shadow: 0 0 10px rgba(255,212,59,0.7); }

        /* ─── GRID WRAPPER ─── */
        .grid-wrapper {
            flex: 1; display: flex;
            align-items: center; justify-content: center;
            position: relative; overflow: hidden; padding: 10px;
        }

        #game-grid {
            display: grid; gap: 2px;
            position: relative; z-index: 5;
        }

        .grid-cell {
            background: rgba(8,12,20,0.8);
            border: 1px solid rgba(0,240,255,0.25);
            border-radius: 3px;
            position: relative; display: flex;
            align-items: center; justify-content: center;
            transition: background 0.2s ease;
            overflow: visible;
        }

        /* ─── ENTITIES ─── */
        .player {
            width: 60%; height: 60%; 
            background: var(--cyan);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            box-shadow: 0 0 20px var(--cyan), 0 0 40px rgba(0,240,255,0.3);
            z-index: 10; position: relative;
            animation: playerPulse 2s ease-in-out infinite;
        }
        @keyframes playerPulse {
            0%,100% { box-shadow: 0 0 10px var(--cyan), 0 0 20px rgba(0,240,255,0.2); }
            50% { box-shadow: 0 0 20px var(--cyan), 0 0 40px rgba(0,240,255,0.4); }
        }
        .player.moving { animation: none; box-shadow: 0 0 25px var(--cyan), 0 0 50px rgba(0,240,255,0.5); }

        .firewall {
            width: 85%; height: 85%;
            background: rgba(255,56,96,0.08);
            border: 1px solid rgba(255,56,96,0.4);
            border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .firewall::before { content: ''; position: absolute; inset: 2px; border: 1px solid rgba(255,56,96,0.2); border-radius: 2px; }
        .firewall-icon { color: var(--red); font-size: 0.8rem; animation: firewallFlicker 3s ease-in-out infinite; }
        @keyframes firewallFlicker { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

        .core {
            width: 55%; height: 55%;
            background: var(--gold);
            border-radius: 3px;
            box-shadow: 0 0 15px var(--gold), 0 0 30px rgba(255,212,59,0.3);
            animation: coreRotate 3s linear infinite;
            position: relative;
        }
        .core::after { content: ''; position: absolute; inset: -3px; border: 1px solid rgba(255,212,59,0.3); border-radius: 4px; animation: coreAura 2s ease-in-out infinite; }
        @keyframes coreRotate { to { transform: rotate(45deg); } }
        @keyframes coreAura { 0%,100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.3); opacity: 0; } }

        /* ─── LAYER STATUS ─── */
        .layer-status {
            padding: 8px 20px;
            background: rgba(4,5,10,0.95);
            border-top: 1px solid var(--border);
            display: flex; gap: 20px; align-items: center;
            flex-shrink: 0;
        }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .stat-icon { font-size: 0.75rem; }
        .stat-label { font-family: var(--font-mono); font-size: 0.68rem; color: #4a5568; letter-spacing: 1px; }
        .stat-value { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text); font-weight: 700; }
        .stat-value.cyan { color: var(--cyan); }
        .stat-value.gold { color: var(--gold); }
        .stat-value.green { color: var(--green); }

        /* ─── RIGHT PANEL ─── */
        .right-panel {
            width: 50%; display: flex; flex-direction: column;
            background: rgba(8,12,20,0.95);
        }

        /* ─── MISSION HEADER ─── */
        .mission-bar {
            padding: 8px 16px;
            background: rgba(4,5,10,0.9);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        .mission-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); animation: blink 2s ease-in-out infinite; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .mission-text { font-family: var(--font-mono); font-size: 0.7rem; color: #5a6880; letter-spacing: 1px; flex: 1; }
        .mission-req {
            font-family: var(--font-mono); font-size: 0.7rem;
            color: var(--gold); background: var(--gold-dim);
            border: 1px solid rgba(255,212,59,0.15);
            padding: 2px 8px; border-radius: 3px; letter-spacing: 0.5px;
        }

        /* ─── EDITOR ─── */
        #monaco-editor { flex: 1; min-height: 0; }

        /* ─── CONTROL BAR ─── */
        .control-bar {
            height: 52px;
            background: rgba(4,5,10,0.9);
            border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; flex-shrink: 0; gap: 10px;
        }

        .ctrl-left { display: flex; align-items: center; gap: 12px; }
        .ctrl-right { display: flex; align-items: center; gap: 8px; }

        .code-stats { display: flex; gap: 12px; }
        .code-stat { font-family: var(--font-mono); font-size: 0.65rem; display: flex; align-items: center; gap: 5px; }
        .code-stat-icon { color: var(--text-dim); }
        .code-stat-val { color: var(--cyan); font-weight: 700; }

        .btn-reset {
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);
            color: var(--cyan); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem;
        }
        .btn-reset:hover { background: var(--cyan); color: #000; transform: rotate(180deg); box-shadow: 0 0 20px rgba(0,240,255,0.4); }

        .btn-run {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 22px; border-radius: 5px;
            background: var(--green); color: #000;
            font-family: var(--font-mono); font-weight: 700; font-size: 0.8rem;
            letter-spacing: 1px; border: none; cursor: pointer;
            transition: all 0.25s ease; text-transform: uppercase;
        }
        .btn-run:hover { box-shadow: 0 0 25px rgba(0,210,106,0.5); transform: translateY(-1px); }
        .btn-run:active { transform: translateY(0); }
        .btn-run:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ─── TERMINAL ─── */
        #terminal {
            height: 120px; flex-shrink: 0;
            background: #030408;
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            font-family: var(--font-mono); font-size: 0.75rem;
            overflow-y: auto; line-height: 1.7;
        }
        #terminal::-webkit-scrollbar { width: 4px; }
        #terminal::-webkit-scrollbar-track { background: transparent; }
        #terminal::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.2); border-radius: 2px; }

        .term-line { display: flex; gap: 8px; align-items: flex-start; }
        .term-prompt { color: var(--cyan); opacity: 0.5; flex-shrink: 0; }
        .term-msg { color: #6b7280; }
        .term-msg.success { color: var(--green); }
        .term-msg.error { color: var(--red); }
        .term-msg.warn { color: var(--gold); }
        .term-msg.info { color: var(--cyan); }
        .term-msg.system { color: #8b9eb8; }

        /* ─── OVERLAYS ─── */
        .fullscreen-overlay {
            position: absolute; inset: 0;
            background: rgba(4,5,10,0.97);
            backdrop-filter: blur(20px);
            z-index: 500;
            display: flex; align-items: center; justify-content: center;
        }

        /* ─── AUTH STYLES ─── */
        .auth-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            color: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-family: var(--font-mono);
        }
        .auth-input:focus { border-color: var(--cyan); outline: none; }
        .auth-error { color: var(--red); font-size: 0.7rem; margin-bottom: 10px; display: none; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .auth-tab {
            padding: 8px 16px; cursor: pointer; color: #5a6880; font-family: var(--font-mono); font-size: 0.8rem;
        }
        .auth-tab.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); }

        /* ─── TUTORIAL & CARDS ─── */
        .tutorial-card {
            max-width: 560px; width: 90%;
            background: var(--surface);
            border: 1px solid rgba(0,240,255,0.15);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 80px rgba(0,240,255,0.08), 0 30px 60px rgba(0,0,0,0.5);
        }
        .tutorial-header {
            padding: 28px 32px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(0,240,255,0.03), transparent);
        }
        .tutorial-header h1 {
            font-family: var(--font-mono); font-size: 1.2rem; color: white;
            letter-spacing: 2px; font-weight: 700;
        }
        .tutorial-header p { color: #5a6880; font-size: 0.85rem; margin-top: 6px; line-height: 1.6; }
        .tutorial-body { padding: 24px 32px; }
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .legend-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 14px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .legend-icon {
            width: 36px; height: 36px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 1.1rem;
        }
        .legend-text strong { display: block; color: white; font-size: 0.85rem; font-weight: 700; }
        .legend-text span { color: #5a6880; font-size: 0.75rem; }
        .tutorial-footer {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            display: flex; justify-content: center;
        }
        .btn-start {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 32px; border-radius: 6px;
            background: rgba(0,240,255,0.06);
            border: 1px solid rgba(0,240,255,0.3);
            color: var(--cyan); font-family: var(--font-mono);
            font-weight: 700; font-size: 0.85rem; letter-spacing: 1px;
            cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
        }
        .btn-start:hover { background: var(--cyan); color: #000; box-shadow: 0 0 40px rgba(0,240,255,0.4); }

        /* ─── LEVEL WIN OVERLAY ─── */
        .win-card {
            max-width: 480px; width: 90%;
            background: var(--surface);
            border: 1px solid rgba(0,210,106,0.2);
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 0 80px rgba(0,210,106,0.1), 0 30px 60px rgba(0,0,0,0.6);
            text-align: center;
        }
        .win-header {
            padding: 32px 32px 20px;
            background: linear-gradient(135deg, rgba(0,210,106,0.05), transparent);
        }
        .win-icon { font-size: 3rem; color: var(--green); margin-bottom: 12px; display: block; }
        .win-title {
            font-family: var(--font-mono); font-size: 1.5rem; font-weight: 900;
            color: white; letter-spacing: 2px;
            background: linear-gradient(to bottom, #fff, var(--green));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .win-subtitle { color: #4a5568; font-size: 0.8rem; letter-spacing: 3px; margin-top: 8px; font-family: var(--font-mono); }
        .win-stats {
            display: flex; justify-content: center; gap: 30px;
            padding: 20px 32px;
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
        }
        .win-stat { text-align: center; }
        .win-stat-val { font-family: var(--font-mono); font-size: 1.4rem; font-weight: 900; color: var(--gold); }
        .win-stat-lbl { font-size: 0.65rem; color: #4a5568; letter-spacing: 2px; margin-top: 2px; }
        .win-stars { display: flex; justify-content: center; gap: 10px; padding: 16px; }
        .win-star { font-size: 1.8rem; color: #1a2030; transition: all 0.4s ease; }
        .win-star.lit { color: var(--gold); text-shadow: 0 0 20px rgba(255,212,59,0.6); }
        .win-footer { padding: 20px 32px 28px; }
        .btn-next {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 12px 32px; border-radius: 6px;
            background: rgba(0,210,106,0.08);
            border: 1px solid rgba(0,210,106,0.3);
            color: var(--green); font-family: var(--font-mono);
            font-weight: 700; font-size: 0.85rem; letter-spacing: 1px;
            cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
        }
        .btn-next:hover { background: var(--green); color: #000; box-shadow: 0 0 40px rgba(0,210,106,0.4); }

        /* ─── LOADER ─── */
        .loader-card { text-align: center; }
        .loader-ring {
            width: 60px; height: 60px; margin: 0 auto 20px;
            border: 2px solid rgba(0,240,255,0.1);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-family: var(--font-mono); font-size: 0.85rem; color: var(--cyan); letter-spacing: 2px; }
        .loader-sub { font-family: var(--font-mono); font-size: 0.7rem; color: #3a4558; margin-top: 8px; letter-spacing: 1px; }

        /* ─── XP POPUP ─── */
        .xp-popup {
            position: fixed; top: 70px; right: 20px; z-index: 9999;
            font-family: var(--font-mono); font-size: 0.85rem; font-weight: 700;
            color: var(--gold); padding: 8px 16px; border-radius: 4px;
            background: rgba(255,212,59,0.1); border: 1px solid rgba(255,212,59,0.3);
            letter-spacing: 1px;
            animation: xpFloat 2.5s ease forwards;
            pointer-events: none;
        }
        @keyframes xpFloat {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            80% { opacity: 1; transform: translateY(-30px); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* ─── CELL STATES ─── */
        .grid-cell.trail {
            background: rgba(0,240,255,0.04);
            border-color: rgba(0,240,255,0.08);
        }
        .grid-cell.win-flash {
            animation: winFlash 0.5s ease;
        }
        @keyframes winFlash {
            0% { background: rgba(0,210,106,0); }
            50% { background: rgba(0,210,106,0.3); }
            100% { background: rgba(0,210,106,0); }
        }

        /* ─── MOBILE ─── */
        @media (max-width: 900px) {
            nav { height: 52px; padding: 0 12px; }
            .xp-area { display: none; }
            .nav-title { display: none; }
            #app { flex-direction: column; }
            .left-panel, .right-panel { width: 100%; }
            .left-panel { flex: 1; min-height: 0; }
            .right-panel { height: 50%; }
            .grid-cell { width: 38px; height: 38px; }
            .legend-grid { grid-template-columns: 1fr; }
        }
        
        /* ─── GRID COORDINATES & UI ─── */
        .coord-btn {
            font-family: var(--font-mono); font-size: 0.65rem; color: #5a6880;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            padding: 4px 8px; border-radius: 3px; cursor: pointer; transition: all 0.2s ease; letter-spacing: 1px;
        }
        .coord-btn:hover, .coord-btn.on { color: var(--cyan); border-color: rgba(0,240,255,0.3); background: rgba(0,240,255,0.1); }
        .col-lbl, .row-lbl { font-family: var(--font-mono); font-size: 10px; color: #4a5568; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .grid-cell::after {
            content: attr(data-coord); position: absolute; bottom: 2px; right: 3px;
            font-family: var(--font-mono); font-size: 8px; color: rgba(0,240,255,0.4);
            pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 1;
        }
        .show-coords .grid-cell::after { opacity: 1; }

        /* ─── DIFFICULTY MODAL ─── */
        .diff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px 32px 32px; }
        .diff-btn {
            padding: 18px 16px; border-radius: 8px; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06); cursor: pointer; display: flex;
            flex-direction: column; align-items: center; gap: 8px; transition: all 0.25s ease; text-align: center;
        }
        .diff-btn:hover { transform: translateY(-2px); }
        .diff-icon { font-size: 1.8rem; }
        .diff-name { font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; }
        .diff-sub { font-size: 0.7rem; color: #5a6880; letter-spacing: 0.5px; }
        .diff-btn.easy { border-color: rgba(0,210,106,0.25); } .diff-btn.easy:hover { background: rgba(0,210,106,0.08); border-color: var(--green); } .diff-btn.easy * { color: var(--green); }
        .diff-btn.medium { border-color: rgba(0,240,255,0.25); } .diff-btn.medium:hover { background: rgba(0,240,255,0.12); border-color: var(--cyan); } .diff-btn.medium * { color: var(--cyan); }
        .diff-btn.hard { border-color: rgba(255,212,59,0.25); } .diff-btn.hard:hover { background: rgba(255,212,59,0.12); border-color: var(--gold); } .diff-btn.hard * { color: var(--gold); }
        .diff-btn.expert { border-color: rgba(255,56,96,0.25); } .diff-btn.expert:hover { background: rgba(255,56,96,0.12); border-color: var(--red); } .diff-btn.expert * { color: var(--red); }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <!-- NAV -->
    <nav>
        <div class="nav-left">
            <a href="index.html" class="nav-logo">
                <img src="codestitcher.png" alt="CodeStitcher" onerror="this.style.display='none'">
                <span class="nav-title">CodeStitcher</span>
            </a>
            <span class="nav-tag">// NEURAL SIM</span>
        </div>
        <div class="xp-area">
            <span class="xp-label" id="xp-label">XP: 0</span>
            <div class="xp-track"><div class="xp-fill" id="xp-fill"></div></div>
            <span class="rank-badge" id="rank-badge">NOVICE</span>
        </div>
        <div class="nav-right">
            <a href="index.html" class="nav-btn btn-home">
                <i class="fa-solid fa-house"></i> <span>Home</span>
            </a>
            <a href="learn-python.html" class="nav-btn btn-exit">
                <i class="fa-solid fa-power-off"></i> <span>Exit</span>
            </a>
        </div>
    </nav>

    <!-- APP -->
    <div id="app">

        <!-- LEFT: GAME -->
        <div class="left-panel" id="left-panel">

            <div class="level-header">
                <div class="level-info">
                    <span class="level-num" id="level-num">LAYER 01</span>
                    <div>
                        <div class="level-name" id="level-name">Motor Control</div>
                        <div class="level-story" id="level-story">Navigate the neural lattice</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="stars-display" id="stars-display">
                        <span class="star">★</span><span class="star">★</span><span class="star">★</span>
                    </div>
                    <button class="coord-btn" id="coord-btn" onclick="toggleCoords()">⊞ COORDS</button>
                </div>
            </div>

            <div class="grid-wrapper" id="grid-wrapper">
                <div style="display: flex; flex-direction: column;">
                    <div class="col-labels" id="col-labels" style="display: flex; margin-bottom: 2px; gap: 2px;"></div>
                    <div style="display: flex; gap: 2px;">
                        <div class="row-labels" id="row-labels" style="display: flex; flex-direction: column; gap: 2px;"></div>
                        <div id="game-grid-container">
                            <div id="game-grid"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layer-status">
                <div class="stat-item">
                    <span class="stat-icon" style="color:var(--cyan)">◈</span>
                    <span class="stat-label">MOVES</span>
                    <span class="stat-value cyan" id="stat-moves">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon" style="color:var(--gold)">⊛</span>
                    <span class="stat-label">BEST</span>
                    <span class="stat-value gold" id="stat-best">—</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon" style="color:var(--green)">◉</span>
                    <span class="stat-label">LAYER</span>
                    <span class="stat-value green" id="stat-layer">1 / 10</span>
                </div>
                <div class="stat-item" style="margin-left: auto;">
                    <span class="stat-icon" style="color:var(--red)">⬡</span>
                    <span class="stat-label">CONCEPT</span>
                    <span class="stat-value" id="stat-concept" style="color:#8899aa">—</span>
                </div>
            </div>
        </div>

        <!-- RIGHT: CODE -->
        <div class="right-panel">

            <div class="mission-bar">
                <div class="mission-dot"></div>
                <span class="mission-text" id="mission-text">AGENT UPLINK ACTIVE</span>
                <span class="mission-req" id="mission-req">—</span>
            </div>

            <div id="monaco-editor"></div>

            <div class="control-bar">
                <div class="ctrl-left">
                    <div class="code-stats">
                        <div class="code-stat">
                            <span class="code-stat-icon"><i class="fa-solid fa-code"></i></span>
                            <span style="color:#4a5568; font-size:0.65rem;">LINES</span>
                            <span class="code-stat-val" id="cs-lines">—</span>
                        </div>
                        <div class="code-stat">
                            <span class="code-stat-icon"><i class="fa-solid fa-bolt"></i></span>
                            <span style="color:#4a5568; font-size:0.65rem;">CONCEPTS</span>
                            <span class="code-stat-val" id="cs-concepts">—</span>
                        </div>
                    </div>
                </div>
                <div class="ctrl-right">
                    <button class="btn-reset" onclick="resetLevel()" title="Reset Level">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </button>
                    <button class="btn-run" id="run-btn" onclick="runCode()">
                        <i class="fa-solid fa-play"></i> EXECUTE
                    </button>
                </div>
            </div>

            <div id="terminal">
                <div class="term-line">
                    <span class="term-prompt">$</span>
                    <span class="term-msg system">Neural simulation v2.0 — Awaiting agent initialization...</span>
                </div>
            </div>

        </div>

    </div>

    <!-- LOADER OVERLAY -->
    <div class="fullscreen-overlay" id="overlay-loader" style="z-index: 9000;">
        <div class="loader-card">
            <div class="loader-ring"></div>
            <div class="loader-text" id="loader-text">LOADING KERNEL</div>
            <div class="loader-sub" id="loader-sub">Please wait...</div>
            <div class="loader-progress" style="margin: 15px auto 0; height:3px; background:rgba(255,255,255,0.1); width:150px; border-radius:2px; overflow:hidden;">
                <div id="loader-progress-fill" style="width:0%; height:100%; background:var(--cyan); transition:width 0.3s;"></div>
            </div>
        </div>
    </div>
    
    <!-- AUTH OVERLAY -->
    <div class="fullscreen-overlay" id="overlay-auth" style="display:none; z-index: 9999;">
        <div class="tutorial-card" style="max-width: 420px; text-align:center;">
            <div class="tutorial-header">
                <h1 id="auth-title">IDENTIFY YOURSELF</h1>
                <p>Connect to Neural Cloud to save progress, or proceed anonymously.</p>
            </div>
            <div class="tutorial-body">
                <div class="auth-tabs" style="justify-content: center;">
                    <div class="auth-tab active" onclick="switchAuthMode('login')" id="tab-login">LOGIN</div>
                    <div class="auth-tab" onclick="switchAuthMode('signup')" id="tab-signup">REGISTER</div>
                </div>
                
                <div id="auth-forms">
                    <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
                    <input type="password" id="auth-pass" class="auth-input" placeholder="Password (6+ chars)">
                    <div class="auth-error" id="auth-error">Error message here</div>

                    <button class="btn-start" onclick="submitAuth()" style="width:100%; justify-content:center; margin-top:10px; margin-bottom: 20px;">
                        <span id="auth-btn-text">AUTHENTICATE</span>
                    </button>
                </div>

                <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                    <p style="font-size: 0.7rem; color: #5a6880; margin-bottom: 10px;">NO ACCOUNT?</p>
                    <button onclick="proceedAsGuest()" class="btn-next" style="width:100%; justify-content:center; background:transparent; border-color:#5a6880; color:#8899aa;">
                        <i class="fa-solid fa-user-secret"></i> PLAY AS GUEST
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DIFFICULTY OVERLAY -->
    <div class="fullscreen-overlay" id="overlay-diff" style="display:none; z-index: 8500;">
        <div class="tutorial-card">
            <div class="tutorial-header">
                <h1>SELECT PROTOCOL</h1>
                <p>Choose your breach difficulty. Each level teaches a new Python concept.</p>
            </div>
            <div class="diff-grid">
                <button class="diff-btn easy" onclick="selectDiff('easy')">
                    <span class="diff-icon">◈</span><span class="diff-name">EASY</span><span class="diff-sub">6×6 · No limit · Basic</span>
                </button>
                <button class="diff-btn medium" onclick="selectDiff('medium')">
                    <span class="diff-icon">⬡</span><span class="diff-name">MEDIUM</span><span class="diff-sub">8×8 · Standard · Loops</span>
                </button>
                <button class="diff-btn hard" onclick="selectDiff('hard')">
                    <span class="diff-icon">⊛</span><span class="diff-name">HARD</span><span class="diff-sub">12×12 · Keys · Portals</span>
                </button>
                <button class="diff-btn expert" onclick="selectDiff('expert')">
                    <span class="diff-icon">∞</span><span class="diff-name">EXPERT</span><span class="diff-sub">Procedural · Endless</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- TUTORIAL OVERLAY -->
    <div class="fullscreen-overlay" id="overlay-tutorial" style="display:none; z-index: 8000;">
        <div class="tutorial-card">
            <div class="tutorial-header">
                <h1>MISSION BRIEFING</h1>
                <p>You are <strong style="color:var(--cyan)">A1-Agent</strong> — an autonomous intelligence escaping a corrupted system. Write Python code to navigate through security layers and reach the Quantum Energy Node.</p>
            </div>
            <div class="tutorial-body">
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-icon" style="background:rgba(0,240,255,0.1); color:var(--cyan);">◈</div>
                        <div class="legend-text">
                            <strong>A1-Agent</strong>
                            <span>Your avatar. Move it with code.</span>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background:rgba(255,212,59,0.1); color:var(--gold);">⊛</div>
                        <div class="legend-text">
                            <strong>Quantum Node</strong>
                            <span>The goal. Reach it to escape.</span>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background:rgba(255,56,96,0.1); color:var(--red);">⬡</div>
                        <div class="legend-text">
                            <strong>Firewall</strong>
                            <span>Fatal. Triggers system crash.</span>
                        </div>
                    </div>
                    <div class="legend-item" style="background: rgba(0,210,106,0.04); border-color: rgba(0,210,106,0.15);">
                        <div class="legend-icon" style="background:rgba(0,210,106,0.1); color:var(--green);">{ }</div>
                        <div class="legend-text">
                            <strong>Commands</strong>
                            <span style="font-family:var(--font-mono); color:var(--cyan); font-size:0.7rem;">agent.move("right", 3)</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px 14px; background: rgba(0,210,106,0.04); border: 1px solid rgba(0,210,106,0.1); border-radius: 6px;">
                    <p style="font-size: 0.75rem; color: #5a6880; line-height: 1.6;">
                        <span style="color:var(--gold); font-family:var(--font-mono); font-size:0.7rem;">★★★ SCORING:</span><br>
                        Complete level (1★) · Use required concept (2★) · Optimal path (3★)
                    </p>
                </div>
            </div>
            <div class="tutorial-footer">
                <button class="btn-start" onclick="closeTutorial()">
                    INITIALIZE UPLINK <i class="fa-solid fa-bolt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- WIN OVERLAY -->
    <div class="fullscreen-overlay" id="overlay-win" style="display:none; z-index: 8000;">
        <div class="win-card">
            <div class="win-header">
                <i class="fa-solid fa-shield-halved win-icon"></i>
                <div class="win-title">LAYER BREACHED</div>
                <div class="win-subtitle">SECURITY PROTOCOL DEFEATED</div>
            </div>
            <div class="win-stars" id="win-stars">
                <span class="win-star">★</span>
                <span class="win-star">★</span>
                <span class="win-star">★</span>
            </div>
            <div class="win-stats">
                <div class="win-stat">
                    <div class="win-stat-val" id="ws-moves">—</div>
                    <div class="win-stat-lbl">MOVES</div>
                </div>
                <div class="win-stat">
                    <div class="win-stat-val" id="ws-xp">—</div>
                    <div class="win-stat-lbl">XP GAINED</div>
                </div>
                <div class="win-stat">
                    <div class="win-stat-val" id="ws-stars">—</div>
                    <div class="win-stat-lbl">STARS</div>
                </div>
            </div>
            <div class="win-footer">
                <button class="btn-next" onclick="nextLevel()">
                    NEXT LAYER <i class="fa-solid fa-forward"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
    // ─── FIREBASE SETUP ───
    const firebaseConfig = {
      apiKey: "AIzaSyC_dO_9rtBfWDe-MNaO1iwl6ucdg3JOM7k",
      authDomain: "codestitcher-ffd29.firebaseapp.com",
      projectId: "codestitcher-ffd29",
      storageBucket: "codestitcher-ffd29.firebasestorage.app",
      messagingSenderId: "823538388373",
      appId: "1:823538388373:web:84018df0271211f14c7a9c"
    };
    
    // Initialize Firebase
    let app, auth, db;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        console.log("Firebase initialized.");
    } catch(e) {
        console.error("Firebase init failed:", e);
    }

    let currentUser = null;
    let authMode = 'login';

    // ─── AUTH FUNCTIONS ───
    function openAuth() {
        document.getElementById('overlay-auth').style.display = 'flex';
        document.getElementById('auth-error').style.display = 'none';
    }

    function closeAuth() {
        document.getElementById('overlay-auth').style.display = 'none';
    }

    function switchAuthMode(mode) {
        authMode = mode;
        document.getElementById('tab-login').classList.toggle('active', mode === 'login');
        document.getElementById('tab-signup').classList.toggle('active', mode === 'signup');
        document.getElementById('auth-btn-text').textContent = mode === 'login' ? 'LOGIN' : 'REGISTER AGENT';
        document.getElementById('auth-title').textContent = mode === 'login' ? 'IDENTIFY YOURSELF' : 'NEW AGENT UPLINK';
    }

    async function submitAuth() {
        // Check if Firebase auth is ready
        if (!auth) {
            const errEl = document.getElementById('auth-error');
            errEl.textContent = "System Error: Neural Uplink Offline. (Firebase not loaded)";
            errEl.style.display = 'block';
            return;
        }

        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        const errEl = document.getElementById('auth-error');
        
        if(!email || !pass) {
            errEl.textContent = "Please enter email and password";
            errEl.style.display = 'block';
            return;
        }

        try {
            if(authMode === 'signup') {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(cred.user.uid).set({
                    email: email, xp: 0, level: 0, difficulty: 'easy', joined: new Date()
                });
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
            // Success logic handled by onAuthStateChanged
            document.getElementById('overlay-auth').style.display = 'none';
            document.getElementById('overlay-diff').style.display = 'flex';
        } catch (error) {
            errEl.textContent = error.message;
            errEl.style.display = 'block';
        }
    }

    function proceedAsGuest() {
        console.log("Proceeding as Guest...");
        document.getElementById('overlay-auth').style.display = 'none';
        document.getElementById('overlay-diff').style.display = 'flex';
    }

    function signOut() {
        if(auth) auth.signOut();
        location.reload();
    }

    // Monitor Auth State
    if(auth) {
        auth.onAuthStateChanged(async (user) => {
            const navRight = document.querySelector('.nav-right');
            if (user) {
                currentUser = user;
                navRight.innerHTML = `
                    <div class="user-profile" style="display:flex">
                        <i class="fa-solid fa-user" style="color:var(--cyan)"></i>
                        <span class="user-email">${user.email}</span>
                    </div>
                    <button class="nav-btn btn-exit" onclick="signOut()">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                `;
                
                // Load User Data
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if(doc.exists) {
                        const data = doc.data();
                        totalXP = data.xp || 0;
                        updateXPBar(0);
                    }
                } catch(e) { console.error("Error loading user data", e); }
                
            } else {
                currentUser = null;
                navRight.innerHTML = `
                    <a href="index.html" class="nav-btn btn-home" style="margin-right:10px;">
                        <i class="fa-solid fa-house"></i> Home
                    </a>
                    <button class="btn-auth" onclick="openAuth()">
                        <i class="fa-solid fa-key"></i> LOGIN / SAVE
                    </button>
                `;
            }
        });
    }

    // ─── CLOUD SAVE ───
    async function saveProgressToCloud() {
        if (!currentUser || !db) return; 

        const userRef = db.collection('users').doc(currentUser.uid);
        const missionText = document.getElementById('mission-text');

        try {
            if(missionText) {
                missionText.textContent = "UPLOADING DATA TO CORE...";
                missionText.style.color = "var(--cyan)";
            }

            const doc = await userRef.get();
            let currentCloudLevel = 0;
            if (doc.exists) {
                currentCloudLevel = doc.data().level || 0;
            }

            const nextUnlockedLevel = gLevel + 1;

            await userRef.update({
                xp: totalXP,
                level: Math.max(currentCloudLevel, nextUnlockedLevel),
                difficulty: diff,
                lastPlayed: new Date()
            });

            console.log("Cloud Save Complete.");
            
            setTimeout(() => { 
                if(missionText) {
                    missionText.textContent = "DATA SYNC COMPLETE.";
                    missionText.style.color = "#5a6880";
                }
            }, 1500);

        } catch (e) {
            console.error("Save Error:", e);
            if(missionText) missionText.textContent = "SYNC ERROR (OFFLINE?)";
        }
    }

    // ─── BACKGROUND PARTICLES ───
    (function() {
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let W, H, nodes = [];

        function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }

        class Node {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * W; this.y = Math.random() * H;
                this.vx = (Math.random() - 0.5) * 0.3; this.vy = (Math.random() - 0.5) * 0.3;
                this.r = Math.random() * 1.2 + 0.3;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < 0 || this.x > W) this.vx *= -1;
                if (this.y < 0 || this.y > H) this.vy *= -1;
            }
        }

        function init() {
            resize();
            nodes = Array.from({ length: 80 }, () => new Node());
        }

        function draw() {
            ctx.clearRect(0, 0, W, H);
            // Connections
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const dx = nodes[i].x - nodes[j].x, dy = nodes[i].y - nodes[j].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 130) {
                        ctx.beginPath();
                        ctx.moveTo(nodes[i].x, nodes[i].y);
                        ctx.lineTo(nodes[j].x, nodes[j].y);
                        ctx.strokeStyle = `rgba(0,240,255,${0.04 * (1 - dist/130)})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                }
            }
            // Nodes
            for (const n of nodes) {
                n.update();
                ctx.beginPath();
                ctx.arc(n.x, n.y, n.r, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(93,95,239,0.6)';
                ctx.fill();
            }
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', init);
        init(); draw();
    })();

    // ─── SOUND ENGINE ───
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function resume() { if (audioCtx.state === 'suspended') audioCtx.resume(); }
    function playTone(freq, type, dur, vol=0.08) {
        resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }
    function playClick() { playTone(900, 'sine', 0.08, 0.05); }
    function playMove()  { playTone(660, 'sine', 0.1, 0.04); }
    function playError() { playTone(180, 'sawtooth', 0.3, 0.06); }
    function playWin()   {
        [500, 700, 900].forEach((f,i) => setTimeout(() => playTone(f, 'sine', 0.4, 0.08), i*120));
    }
    function playStart() { playTone(440, 'triangle', 0.3, 0.05); }

    // ─── PROGRESSION ───
    const RANKS = [
        { name: 'NOVICE', xpNeeded: 0 },
        { name: 'INITIATE', xpNeeded: 100 },
        { name: 'DEVELOPER', xpNeeded: 250 },
        { name: 'ARCHITECT', xpNeeded: 500 },
        { name: 'GRANDMASTER', xpNeeded: 800 },
    ];
    let totalXP = 0;

    function getRank(xp) {
        for (let i = RANKS.length - 1; i >= 0; i--) {
            if (xp >= RANKS[i].xpNeeded) return { rank: RANKS[i], next: RANKS[i+1] || null, idx: i };
        }
        return { rank: RANKS[0], next: RANKS[1], idx: 0 };
    }

    function updateXPBar(xpGained=0) {
        const { rank, next } = getRank(totalXP);
        const pct = next ? ((totalXP - rank.xpNeeded) / (next.xpNeeded - rank.xpNeeded)) * 100 : 100;
        document.getElementById('xp-fill').style.width = pct + '%';
        document.getElementById('xp-label').textContent = `XP: ${totalXP}`;
        document.getElementById('rank-badge').textContent = rank.name;
        if (xpGained > 0) {
            const popup = document.createElement('div');
            popup.className = 'xp-popup';
            popup.textContent = `+${xpGained} XP`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 2600);
        }
    }

    // ─── LEVELS ───
    const LEVELS = { 
  easy: [
    // ========================
    // EASY MODE (E1–E10)
    // ========================
    { 
      layer:'E1', name:'Basic Movement', story:'Initialize motor system and reach the node.', 
      concept:'agent.move()', reqText:'Call agent.move()', reqRegex:/move/, optMoves:6, moveLimit:-1, xpBase:30, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E1: Basic Movement
# Welcome, A1-Agent. Your avatar is the cyan triangle.
# The goal is to reach the Quantum Node (gold spinning square).
# 
# Use the agent.move() command. 
# It takes a direction ("up", "down", "left", "right") and a number of steps.
# Example: agent.move("down", 5)

` 
    }, 
    { 
      layer:'E2', name:'Multiple Directions', story:'Combine horizontal and vertical movement.', 
      concept:'agent.move()', reqText:'Use agent.move() multiple times', reqRegex:/move/, optMoves:8, moveLimit:-1, xpBase:35, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,1,0,1,0],[0,0,0,0,0,0],[0,1,1,0,1,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E2: Multiple Directions
# Firewalls (red boxes with X's) will instantly crash your system!
# You must combine different directional moves to navigate around them.
# 
# Chain multiple agent.move() commands together to zigzag to the core.

` 
    }, 
    { 
      layer:'E3', name:'Variables', story:'Store step counts inside memory.', 
      concept:'Variables', reqText:'Define a variable', reqRegex:/[a-zA-Z_]\w*\s*=/, optMoves:8, moveLimit:-1, xpBase:40, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E3: Memory Allocation (Variables)
# Storing data in variables makes your code cleaner and reusable.
# Define a variable (e.g., steps = 2) and pass it into your move command.
# 
# Example:
# my_steps = 3
# agent.move("right", my_steps)

` 
    }, 
    { 
      layer:'E4', name:'Arithmetic Logic', story:'Calculate movement dynamically.', 
      concept:'Arithmetic', reqText:'Use + - * or /', reqRegex:/[\+\-\*\/]/, optMoves:10, moveLimit:-1, xpBase:45, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,1,1,0,0],[0,0,0,0,0,0],[0,1,1,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E4: Arithmetic Logic
# You can do math inside your code to calculate exactly how far to move.
# You must use an arithmetic operator (+, -, *, or /) to pass this layer.
# 
# Example:
# agent.move("down", 1 + 1)
# agent.move("right", 2 * 2)

` 
    }, 
    { 
      layer:'E5', name:'Conditional Check', story:'Movement depends on condition.', 
      concept:'if', reqText:'Use an if statement', reqRegex:/if\s+/, optMoves:10, moveLimit:-1, xpBase:50, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E5: Conditional Check
# Introduce decision-making into your protocol using 'if' statements.
# The code inside the 'if' block only runs if the condition is True.
# 
# Example:
# execute_protocol = True
# if execute_protocol:
#     agent.move("down", 2)

` 
    }, 
    { 
      layer:'E6', name:'Branching Logic', story:'Choose between two paths.', 
      concept:'if-else', reqText:'Use if-else', reqRegex:/else/, optMoves:12, moveLimit:-1, xpBase:55, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,1,0,1,0,0],[3,0,0,0,0,0],[0,0,0,0,0,0]], 
      code:`import agent

# LAYER E6: Branching Logic
# Expand your decision-making with 'else'. 
# If the first condition is False, it will execute the fallback code.
#
# Example:
# path_clear = False
# if path_clear:
#     agent.move("right", 5)
# else:
#     agent.move("down", 2)

` 
    }, 
    { 
      layer:'E7', name:'For Loop', story:'Remove repetition using iteration.', 
      concept:'for loop', reqText:'Use a for loop', reqRegex:/for\s+\w+\s+in/, optMoves:10, moveLimit:-1, xpBase:60, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,1,1,1,0],[0,0,0,0,0,0],[0,1,1,1,1,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E7: Iteration Protocol (For Loops)
# Don't write the same commands over and over!
# Use a 'for' loop to repeat actions efficiently to navigate the zigzag.
#
# Example:
# for i in range(3):
#     agent.move("right", 1)
#     agent.move("down", 1)

` 
    }, 
    { 
      layer:'E8', name:'While Loop', story:'Loop until condition is false.', 
      concept:'while loop', reqText:'Use a while loop', reqRegex:/while\s+/, optMoves:10, moveLimit:-1, xpBase:65, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,0,1,0,1],[0,1,0,1,0,1],[0,1,0,1,0,1],[0,1,0,1,0,1],[3,1,0,1,0,1]], 
      code:`import agent

# LAYER E8: While Loop
# 'while' loops continue running as long as a condition remains True.
# Great for continuous movement until a variable reaches zero.
#
# Example:
# steps = 4
# while steps > 0:
#     agent.move("down", 1)
#     steps -= 1

` 
    }, 
    { 
      layer:'E9', name:'Functions', story:'Encapsulate repeated behavior.', 
      concept:'def', reqText:'Define a function', reqRegex:/def\s+\w+\(/, optMoves:12, moveLimit:-1, xpBase:70, w:6, h:6, 
      map:[[2,0,0,0,0,0],[0,1,0,1,0,0],[0,1,0,1,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]], 
      code:`import agent

# LAYER E9: Functional Abstraction
# You can define your own custom commands using 'def'.
# Build a function that handles your movement logic, then call it!
#
# Example:
# def go_around():
#     agent.move("right", 2)
#     agent.move("down", 4)
#
# go_around()

` 
    }, 
    { 
      layer:'E10', name:'List Iteration', story:'Store route instructions inside a list.', 
      concept:'Lists', reqText:'Use a list', reqRegex:/\[.*\]/, optMoves:14, moveLimit:-1, xpBase:80, w:6, h:6, 
      map:[[2,0,0,3,0,0],[0,1,1,0,1,1],[0,0,0,0,0,0],[1,1,0,1,1,0],[0,0,0,0,0,0],[0,0,0,0,0,0]], 
      code:`import agent

# LAYER E10: Data Structures (Lists)
# Lists allow you to store a sequence of data, like route directions.
# You can loop through a list to execute an entire path systematically.
#
# Example:
# route = ["right", "right", "down", "down"]
# for direction in route:
#     agent.move(direction, 1)

` 
    } 
  ], 
  medium: [
    // ========================
    // MEDIUM MODE (M1–M10)
    // ========================
    { 
      layer:'M1', name:'Nested Loops', story:'Traverse patterned structures.', 
      concept:'Nested loops', reqText:'Use nested loops', reqRegex:/for[\s\S]*for/, optMoves:18, moveLimit:-1, xpBase:100, w:8, h:8, 
      map:[[2,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M1: Nested Loops
# The maze features repeating corridor structures.
# Use a loop INSIDE another loop to conquer complex repetitive geometry.
#
# Example:
# for _ in range(3):
#     for _ in range(2):
#         agent.move("right", 1)
#     agent.move("down", 1)

` 
    }, 
    { 
      layer:'M2', name:'Dynamic Patterns', story:'Generate movement dynamically.', 
      concept:'Pattern logic', reqText:'Use arithmetic inside loop', reqRegex:/for[\s\S]*[\+\-\*\/]/, optMoves:20, moveLimit:-1, xpBase:110, w:8, h:8, 
      map:[[2,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M2: Dynamic Patterns
# Instead of hardcoding steps, use loop variables mathematically!
# You must use an arithmetic operator (+, -, *, /) INSIDE a for loop.
#
# Example:
# for i in range(1, 4):
#     agent.move("down", i * 2)

` 
    }, 
    { 
      layer:'M3', name:'Parameterized Functions', story:'Create flexible reusable logic.', 
      concept:'Function parameters', reqText:'Define function with parameter', reqRegex:/def\s+\w+\(\w+/, optMoves:20, moveLimit:-1, xpBase:120, w:8, h:8, 
      map:[[2,0,0,0,0,0,0,0],[0,1,1,1,0,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,0,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,0,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M3: Parameterized Functions
# Make your functions adaptable by passing variables into them.
# Create a function that accepts 'direction' and 'distance' arguments.
#
# Example:
# def travel(d, n):
#     agent.move(d, n)
#
# travel("right", 5)

` 
    }, 
    { 
      layer:'M4', name:'Condition Inside Loop', story:'Combine iteration and branching.', 
      concept:'Loop + if', reqText:'Use if inside loop', reqRegex:/for[\s\S]*if/, optMoves:22, moveLimit:-1, xpBase:130, w:8, h:8, 
      map:[[2,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,0],[0,0,0,0,0,0,0,0],[3,0,0,0,0,0,0,0]], 
      code:`import agent

# LAYER M4: Condition Inside Loop
# By placing an 'if' inside a 'for' loop, you can make the agent change
# its behavior on specific cycles (like odd or even steps).
#
# Example:
# for i in range(4):
#     if i % 2 == 0:
#         agent.move("right", 2)
#     else:
#         agent.move("left", 2)

` 
    }, 
    { 
      layer:'M5', name:'2D Grid Traversal', story:'Navigate full grid space.', 
      concept:'2D traversal', reqText:'Use nested iteration', reqRegex:/for[\s\S]*for/, optMoves:24, moveLimit:-1, xpBase:140, w:9, h:9, 
      map:Array(9).fill().map((_,i)=>Array(9).fill(i===0?2:(i===8?3:0))), 
      code:`import agent

# LAYER M5: 2D Grid Traversal
# The space is entirely open. Traverse from the top-left to the bottom-right.
# Write a nested loop (a loop inside a loop) to sweep across the grid.

` 
    }, 
    { 
      layer:'M6', name:'Path as Tuples', story:'Store coordinates as data.', 
      concept:'Tuples', reqText:'Use tuple', reqRegex:/\(/, optMoves:22, moveLimit:-1, xpBase:150, w:8, h:8, 
      map:[[2,0,0,0,0,0,0,0],[0,1,1,0,1,1,0,0],[0,0,0,0,0,0,0,0],[0,1,1,0,1,1,0,0],[0,0,0,0,0,0,0,0],[0,1,1,0,1,1,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M6: Path Stored as Tuples
# Tuples are immutable lists. You can use them to store complex pairs of data.
# Build a list of tuples containing (direction, steps) and iterate through it!
#
# Example:
# route_data = [("right", 3), ("down", 2), ("left", 3)]
# for d, n in route_data:
#     agent.move(d, n)

` 
    }, 
    { 
      layer:'M7', name:'State Tracking', story:'Track logical state during run.', 
      concept:'Boolean state', reqText:'Use boolean variable', reqRegex:/True|False/, optMoves:24, moveLimit:-1, xpBase:160, w:8, h:8, 
      map:[[2,0,4,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M7: State Tracking
# Create a boolean (True/False) variable to act as a logic switch in your code.
# (Note: The map contains a Key (cyan 🔑) you can collect along the way!)
#
# Example:
# going_right = True
# if going_right:
#     agent.move("right", 7)

` 
    }, 
    { 
      layer:'M8', name:'Multi Objective', story:'Complete multiple goals.', 
      concept:'Multiple targets', reqText:'Use loop structure', reqRegex:/for|while/, optMoves:28, moveLimit:-1, xpBase:170, w:9, h:9, 
      map:[[2,0,4,0,0,4,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M8: Multi-Objective Route
# There are multiple Keys on the map! While not mandatory for survival yet,
# practice navigating to specific objects before heading to the Quantum Node.
# Use loops to efficiently wind your way through the maze.

` 
    }, 
    { 
      layer:'M9', name:'Efficiency Optimization', story:'Operate under strict move limit.', 
      concept:'Optimization', reqText:'Use loop', reqRegex:/for|while/, optMoves:26, moveLimit:30, xpBase:180, w:9, h:9, 
      map:[[2,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER M9: Efficiency Optimization
# WARNING: MOVE LIMIT ACTIVE. 
# You only have 30 moves available before your agent loses power.
# Calculate the absolute shortest path to the exit. Do not waste a single step.

` 
    }, 
    { 
      layer:'M10', name:'Branching Maze', story:'Adapt to non-linear maze.', 
      concept:'Adaptive logic', reqText:'Use condition + loop', reqRegex:/if[\s\S]*for|while/, optMoves:30, moveLimit:-1, xpBase:200, w:10, h:10, 
      map:Array(10).fill().map((_,i)=>Array(10).fill(i===0?2:(i===9?3:(i%2?1:0)))), 
      code:`import agent

# LAYER M10: Branching Maze
# A complex series of walls requires adaptive coding.
# You must combine 'if' statements with loops ('for' or 'while') to pass
# the medium mode final test. Plan your execution flawlessly.

` 
    } 
  ], 
  hard: [
    // ========================
    // HARD MODE (H1–H10)
    // ========================
    { 
      layer:'H1', name:'Key & Lock Logic', story:'Collect key before unlocking.', 
      concept:'System logic', reqText:'Use loop', reqRegex:/for|while/, optMoves:40, moveLimit:60, xpBase:220, w:12, h:12, 
      map:[[2,0,0,0,0,0,4,0,0,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,5,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER H1: Key & Lock Logic
# NEW MECHANIC: Locked Doors (orange 🚪) block your path!
# You MUST collect a Key (cyan 🔑) before you can pass through the door.
# If you hit a door without a key, you will crash. Route accordingly.

` 
    }, 
    { 
      layer:'H2', name:'Portal Teleportation', story:'Adapt to teleport system.', 
      concept:'Non-linear path', reqText:'Use condition', reqRegex:/if/, optMoves:42, moveLimit:65, xpBase:240, w:12, h:12, 
      map:[[2,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,6,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,7,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER H2: Portal Teleportation
# NEW MECHANIC: Quantum Portals (purple circles ⊚).
# Stepping into a portal will instantly warp your agent to the linked portal.
# Use this to bypass impassable walls.

` 
    }, 
    { 
      layer:'H3', name:'Fragment Order', story:'Collect fragments efficiently.', 
      concept:'Ordering logic', reqText:'Use loop', reqRegex:/for|while/, optMoves:45, moveLimit:70, xpBase:260, w:12, h:12, 
      map:[[2,0,0,8,0,0,0,0,0,0,0,0],[0,1,1,1,0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,8,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,8,0,0,0,0,0,0,0,0],[0,1,1,1,0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,3]], 
      code:`import agent

# LAYER H3: Fragment Order
# NEW MECHANIC: Data Fragments (green stars ★).
# Collecting fragments gives you bonus XP and unlocks 3-star ratings!
# Route yourself to collect all 3 fragments before reaching the exit.

` 
    }, 
    { 
      layer:'H4', name:'Resource Constraint', story:'Strict move optimization.', 
      concept:'Optimization', reqText:'Use loop', reqRegex:/for|while/, optMoves:38, moveLimit:45, xpBase:280, w:12, h:12, 
      map:Array(12).fill().map((_,i)=>Array(12).fill(i===0?2:(i===11?3:(i%2?1:0)))), 
      code:`import agent

# LAYER H4: Resource Constraint
# No gimmicks, just brutal efficiency.
# The move limit is tight. Write highly optimized loop sequences 
# to shave off every unnecessary step.

` 
    }, 
    { 
      layer:'H5', name:'Multiple Keys', story:'Handle layered dependencies.', 
      concept:'State logic', reqText:'Use boolean', reqRegex:/True|False/, optMoves:50, moveLimit:80, xpBase:300, w:13, h:13, 
      map:Array(13).fill().map((_,i)=>Array(13).fill(i===0?2:(i===12?3:(i%5===0?4:0)))), 
      code:`import agent

# LAYER H5: Multiple Keys
# A heavily fortified corridor. You will need multiple keys to open 
# successive locked doors. Collect them as you go.

` 
    }, 
    { 
      layer:'H6', name:'Dynamic Obstacles', story:'React to environmental changes.', 
      concept:'Adaptive logic', reqText:'Use condition', reqRegex:/if/, optMoves:55, moveLimit:85, xpBase:320, w:13, h:13, 
      map:Array(13).fill().map((_,i)=>Array(13).fill(i===0?2:(i===12?3:(i%2?1:0)))), 
      code:`import agent

# LAYER H6: Dynamic Obstacles
# Thick firewalls force you into a massive zigzag.
# Build an adaptive pathfinder utilizing conditions ('if').

` 
    }, 
    { 
      layer:'H7', name:'XP vs Shortest Path', story:'Balance efficiency and reward.', 
      concept:'Strategic logic', reqText:'Use loop', reqRegex:/for|while/, optMoves:48, moveLimit:75, xpBase:340, w:13, h:13, 
      map:Array(13).fill().map((_,i)=>Array(13).fill(i===0?2:(i===12?3:(i%4===0?4:0)))), 
      code:`import agent

# LAYER H7: Strategic Choice
# Do you have enough moves to grab the data fragments?
# The move limit forces you to decide between max XP and safe survival.

` 
    }, 
    { 
      layer:'H8', name:'Risk-Reward Route', story:'Choose safer or faster route.', 
      concept:'Decision logic', reqText:'Use if-else', reqRegex:/else/, optMoves:60, moveLimit:90, xpBase:360, w:14, h:14, 
      map:Array(14).fill().map((_,i)=>Array(14).fill(i===0?2:(i===13?3:(i%2?1:0)))), 
      code:`import agent

# LAYER H8: Risk-Reward Route
# Code an 'if-else' branching logic to manage your pathway.
# Map out your coordinates carefully!

` 
    }, 
    { 
      layer:'H9', name:'Forced Reusability', story:'Must define multiple functions.', 
      concept:'Abstraction', reqText:'Define at least two functions', reqRegex:/def[\s\S]*def/, optMoves:55, moveLimit:85, xpBase:380, w:14, h:14, 
      map:Array(14).fill().map((_,i)=>Array(14).fill(i===0?2:(i===13?3:0))), 
      code:`import agent

# LAYER H9: Forced Reusability
# Architecture challenge: You MUST define at least TWO 'def' functions
# in your script to proceed. Structure your logic cleanly.

` 
    }, 
    { 
      layer:'H10', name:'Final Protocol', story:'All mechanics active. Full system mastery.', 
      concept:'Full integration', reqText:'Use functions + loops', reqRegex:/def[\s\S]*for|while/, optMoves:70, moveLimit:100, xpBase:500, w:15, h:15, 
      map:[
        [2,0,0,0,0,4,0,0,8,0,0,0,0,0,0],
        [0,1,1,1,1,1,0,1,1,0,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,0,1,0,1,1,1],
        [0,0,0,0,6,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,5,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,7,1,1,8,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,8,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,3]
      ], 
      code:`import agent

# LAYER H10: Final Protocol (GRANDMASTER)
# This is it. Keys, Doors, Portals, Fragments, Limits.
# Prove your mastery of the neural lattice.
# You must use custom functions and loops together. Good luck, Agent.

` 
    } 
  ] 
};
    let expertConceptIdx = 0;
    const EXPERT_CONCEPTS = [
      {concept:'Loops', reqText:'Use a for loop', reqRegex:/for\s+\w+\s+in/, xpBase:200, code:`import agent\n# EXPERT: Procedural Maze\nfor _ in range(5):\n    agent.move("right", 1)\n`},
      {concept:'Functions', reqText:'Define a function', reqRegex:/def/, xpBase:200, code:`import agent\n# EXPERT: New procedural layout\ndef go(d, n):\n    agent.move(d, n)\n`}
    ];

    function genMaze(W,H){
      const g=Array.from({length:H},()=>Array(W).fill(1));
      function carve(x,y){
        const dirs=[[0,-2],[2,0],[0,2],[-2,0]].sort(()=>Math.random()-.5);
        for(const[dx,dy]of dirs){
          const nx=x+dx, ny=y+dy;
          if(nx>0&&nx<W-1&&ny>0&&ny<H-1&&g[ny][nx]===1){ g[y+dy/2][x+dx/2]=0; g[ny][nx]=0; carve(nx,ny); }
        }
      }
      g[1][1]=0; carve(1,1); g[1][1]=2; g[H-2][W-2]=3;
      return{w:W, h:H, map:g};
    }

    function getExpertLevel(){
      const c = EXPERT_CONCEPTS[expertConceptIdx % EXPERT_CONCEPTS.length];
      const {w,h,map} = genMaze(15,15);
      return { layer:'EX'+(expertConceptIdx+1), name:'Expert Maze', story:'Procedurally generated. Navigate the unknown.', ...c, optMoves:999, w, h, map };
    }

    // ─── STATE ───
    let pyodide = null, editor = null;
    let gLevel = 0, playerPos = {x:0,y:0};
    let moveQueue = [], isPlaying = false;
    let moveCount = 0, bestScores = {};
    let lastUsedConcept = false, lastMoveCount = 0;

    let levels = [];
    let diff = 'easy';
    let showCoords = false;
    let mapState = [];
    let inventory = {keys: 0, frags: 0};
    
    // ─── INIT ───
    window.addEventListener('DOMContentLoaded', async () => {
        const setText = (msg, sub='') => {
            document.getElementById('loader-text').textContent = msg;
            document.getElementById('loader-sub').textContent = sub;
        };
        
        async function initPyodide() {
            setText('LOADING PYTHON ENGINE', 'Fetching Pyodide runtime (~10MB)...');
            document.getElementById('loader-progress-fill').style.width = '30%';
            
            pyodide = await loadPyodide({
                indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/'
            });
            
            document.getElementById('loader-progress-fill').style.width = '70%';
            setText('PYTHON READY', 'Setting up agent module...');

            // BRIDGE SETUP: Define JS function for Python to call
            window.addToQueue = (d, s) => {
                moveQueue.push({d: String(d), s: parseInt(s) || 1});
            };

            // CREATE VIRTUAL PYTHON FILE
            pyodide.FS.writeFile('agent_module.py', `
import js
import sys

def move(direction, steps=1):
    direction = str(direction).lower()
    try:
        steps = int(steps)
    except:
        steps = 1
        
    valid_dirs = ["up", "down", "left", "right"]
    if direction not in valid_dirs:
        raise ValueError(f"Invalid direction '{direction}'. Use: {', '.join(valid_dirs)}")
    
    # Direct call to JavaScript
    js.addToQueue(direction, steps)
`);

            // REGISTER MODULE
            pyodide.runPython(`
import sys
import agent_module
sys.modules['agent'] = agent_module
`);
            document.getElementById('loader-progress-fill').style.width = '100%';
        }

        try {
            // Monaco Init
            setText('INITIALIZING EDITOR', 'Loading code environment...');
            await new Promise(resolve => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' }});
                require(['vs/editor/editor.main'], () => {
                    monaco.editor.defineTheme('neural', {
                        base: 'vs-dark',
                        inherit: true,
                        rules: [
                            { token: 'keyword', foreground: '00F0FF' },
                            { token: 'string', foreground: 'FFD43B' },
                            { token: 'comment', foreground: '3a4558', fontStyle: 'italic' },
                            { token: 'number', foreground: '00D26A' },
                            { token: 'identifier', foreground: 'c0cfe0' },
                        ],
                        colors: {
                            'editor.background': '#08080f',
                            'editor.foreground': '#c0cfe0',
                            'editorLineNumber.foreground': '#1e2840',
                            'editorLineNumber.activeForeground': '#00F0FF',
                            'editor.selectionBackground': '#00F0FF20',
                            'editorCursor.foreground': '#00F0FF',
                            'editorIndentGuide.background': '#0d1220',
                        }
                    });
                    editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                        value: '# Select difficulty to begin...',
                        language: 'python',
                        theme: 'neural',
                        fontFamily: 'JetBrains Mono',
                        fontSize: 13,
                        lineHeight: 22,
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        padding: { top: 14, bottom: 14 },
                        renderLineHighlight: 'line',
                        lineNumbers: 'on',
                        overviewRulerBorder: false,
                        smoothScrolling: true,
                        cursorBlinking: 'smooth',
                        cursorSmoothCaretAnimation: 'on',
                    });
                    editor.onDidChangeModelContent(() => updateCodeStats());
                    resolve();
                });
            });

            // Pyodide Init
            await initPyodide();

            setText('SYSTEM READY', 'Launching neural simulation...');
            await new Promise(r => setTimeout(r, 600));

            document.getElementById('overlay-loader').style.display = 'none';
            
            // AUTH FLOW CHECK
            if (currentUser) {
                console.log("User already authenticated.");
                document.getElementById('overlay-diff').style.display = 'flex';
            } else {
                openAuth(); 
            }

        } catch(e) {
            setText('KERNEL ERROR', e.message || 'Unknown error');
            console.error(e);
        }
    });


    // ─── LEVEL MANAGEMENT ───
    function initLevel(idx) {
        gLevel = idx;
        const lv = levels[idx];
        moveCount = 0;
        mapState = lv.map.map(row => [...row]);
        inventory = {keys: 0, frags: 0};

        document.getElementById('level-num').textContent = `LAYER ${lv.layer}`;
        document.getElementById('level-name').textContent = lv.name;
        document.getElementById('level-story').textContent = lv.story;
        document.getElementById('stat-layer').textContent = `${idx+1} / ${levels.length}`;
        document.getElementById('stat-moves').textContent = '0';
        document.getElementById('stat-concept').textContent = lv.concept;
        document.getElementById('mission-text').textContent = lv.story;
        document.getElementById('mission-req').textContent = lv.reqText;

        const best = bestScores[idx];
        document.getElementById('stat-best').textContent = best ? String(best) : '—';

        // Stars
        const starsEl = document.getElementById('stars-display');
        starsEl.querySelectorAll('.star').forEach(s => s.classList.remove('earned'));

        if (editor) editor.setValue(lv.code);
        updateCodeStats();
        renderGrid();
        log(`Layer ${lv.layer} initialized. Concept: ${lv.concept}`, 'info');
        log(lv.reqText, 'warn');
    }
    
	function selectDiff(d) {
        diff = d;
        document.getElementById('overlay-diff').style.display = 'none';
        document.getElementById('overlay-tutorial').style.display = 'flex';
        if (d === 'expert') {
            levels = [getExpertLevel()];
        } else {
            levels = LEVELS[d];
        }
        gLevel = 0;
        initLevel(0);
        log(`Protocol: ${d.toUpperCase()} selected.`, 'info');
    }

    function toggleCoords() {
        showCoords = !showCoords;
        document.getElementById('game-grid-container').classList.toggle('show-coords', showCoords);
        document.getElementById('coord-btn').classList.toggle('on', showCoords);
    }

    function renderGrid() {
        const lv = levels[gLevel];
        const grid = document.getElementById('game-grid');
        const wrapper = document.getElementById('grid-wrapper');
        
        // Calculate dynamic cell size to fit screen
        const availW = wrapper.clientWidth - 40; 
        const availH = wrapper.clientHeight - 40;
        
        const cols = lv.w + 1; // +1 for the label column
        const rows = lv.h + 1; // +1 for the label row
        
        const maxCellW = Math.floor(availW / cols) - 2; 
        const maxCellH = Math.floor(availH / rows) - 2; 
        
        let cellSize = Math.min(maxCellW, maxCellH);
        if (cellSize > 54) cellSize = 54; // Don't let it get too huge
        if (cellSize < 15) cellSize = 15; // Don't let it vanish

        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${lv.w}, ${cellSize}px)`;

        // Setup Labels
        const colEl = document.getElementById('col-labels'); colEl.innerHTML = '';
        const corner = document.createElement('div');
        corner.style.width = `${cellSize}px`; // Empty corner space
        colEl.appendChild(corner);

        for(let x=0; x<lv.w; x++) {
            const d = document.createElement('div'); d.className = 'col-lbl'; d.textContent = x; 
            d.style.width = `${cellSize}px`;
            colEl.appendChild(d);
        }
        
        const rowEl = document.getElementById('row-labels'); rowEl.innerHTML = '';
        for(let y=0; y<lv.h; y++) {
            const d = document.createElement('div'); d.className = 'row-lbl'; d.textContent = y; 
            d.style.height = `${cellSize}px`; d.style.width = `${cellSize}px`;
            rowEl.appendChild(d);
        }

        for (let y = 0; y < lv.h; y++) {
            for (let x = 0; x < lv.w; x++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.id = `c-${x}-${y}`;
                cell.dataset.coord = `${x},${y}`;
                
                // Apply dynamic size
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;

                const t = mapState[y][x]; 
                if (t === 2) {
                    if (!isPlaying) playerPos = {x, y};
                    if (x === playerPos.x && y === playerPos.y) cell.innerHTML = '<div class="player"></div>';
                }
                if (t === 1) cell.innerHTML = '<div class="firewall"><i class="fa-solid fa-xmark firewall-icon"></i></div>';
                if (t === 3) cell.innerHTML = '<div class="core"></div>';
                if (t === 4) cell.innerHTML = '<div style="color:var(--cyan); font-size:80%;"><i class="fa-solid fa-key"></i></div>';
                if (t === 5) cell.innerHTML = '<div style="color:#FF8C42; font-size:80%;"><i class="fa-solid fa-lock"></i></div>';
                if (t === 6 || t === 7) cell.innerHTML = '<div style="width:70%;height:70%;border-radius:50%;background:rgba(155,93,229,0.3);border:2px solid #9B5DE5;"></div>';
                if (t === 8) cell.innerHTML = '<div style="color:var(--green); font-size:80%;">★</div>';
                
                grid.appendChild(cell);
            }
        }
    }

    // ─── CODE ANALYTICS ───
    function updateCodeStats() {
        if (!editor) return;
        const code = editor.getValue();
        const lines = code.split('\n').filter(l => l.trim() && !l.trim().startsWith('#')).length;
        const concepts = detectConcepts(code);
        document.getElementById('cs-lines').textContent = lines || '—';
        document.getElementById('cs-concepts').textContent = concepts.length ? concepts.join(', ') : '—';
    }

    function detectConcepts(code) {
        const c = [];
        if (/def\s+\w+\(/.test(code)) c.push('def');
        if (/for\s+\w+\s+in/.test(code)) c.push('for');
        if (/while\s+/.test(code)) c.push('while');
        if (/\[.*\]/.test(code)) c.push('list');
        if (/[a-zA-Z_]\w*\s*=\s*\d/.test(code)) c.push('var');
        return c;
    }

    // ─── RUN CODE ───
    async function runCode() {
        if (isPlaying) return;
        if (!pyodide) { log('Kernel not ready.', 'error'); return; }

        const lv = levels[gLevel];
        mapState = lv.map.map(row => [...row]);
        inventory = {keys: 0, frags: 0};

        moveQueue = [];
        renderGrid();
        moveCount = 0;
        document.getElementById('stat-moves').textContent = '0';

        const code = editor.getValue();

        // Requirement check
        if (!lv.reqRegex.test(code)) {
            log('PROTOCOL REJECTED: Missing concept — ' + lv.reqText, 'error');
            playError();
            return;
        }

        lastUsedConcept = detectConcepts(code).length > 0;
        log('Compiling agent protocol...', 'system');
        playStart();

        const btn = document.getElementById('run-btn');
        btn.disabled = true;

        try {
            await pyodide.runPythonAsync(code);
            if (moveQueue.length > 0) {
                await playQueue();
            } else {
                log('No movement commands detected.', 'warn');
            }
        } catch (err) {
            log('Syntax error: ' + (err.message || err), 'error');
            playError();
        }

        btn.disabled = false;
    }

    async function playQueue() {
        isPlaying = true;
        const trail = new Set();

        for (const mv of moveQueue) {
            for (let i = 0; i < mv.s; i++) {
                await new Promise(r => setTimeout(r, 280));
                playMove();

                const res = movePlayer(mv.d, trail);
                moveCount++;
                document.getElementById('stat-moves').textContent = moveCount;

                if (res === 'crash') {
                    log('CRASH: Agent hit a firewall. Connection severed.', 'error');
                    playError();
                    isPlaying = false;
                    return;
                }
                if (res === 'win') {
                    lastMoveCount = moveCount;
                    handleWin();
                    return;
                }
            }
        }

        isPlaying = false;
        log('Protocol complete. Quantum Node not reached.', 'warn');
    }

    function movePlayer(dir, trail) {
        const dx = dir === 'right' ? 1 : dir === 'left' ? -1 : 0;
        const dy = dir === 'down' ? 1 : dir === 'up' ? -1 : 0;
        const nx = playerPos.x + dx, ny = playerPos.y + dy;
        const lv = levels[gLevel];

        if (nx < 0 || nx >= lv.w || ny < 0 || ny >= lv.h) return 'crash';
        
        let t = mapState[ny][nx];
        if (t === 1) return 'crash';

        // Doors
        if (t === 5) {
            if (inventory.keys > 0) {
                inventory.keys--;
                mapState[ny][nx] = 0;
                log(`Door unlocked! Keys remaining: ${inventory.keys}`, 'success');
            } else {
                log('CRASH: Locked Door! You need a KEY.', 'error');
                return 'crash';
            }
        }

        // Clear trail
        const oldCell = document.getElementById(`c-${playerPos.x}-${playerPos.y}`);
        if (oldCell) {
            oldCell.innerHTML = '';
            let oldT = mapState[playerPos.y][playerPos.x];
            // Redraw portals if we step off them
            if (oldT === 6 || oldT === 7) {
                oldCell.innerHTML = '<div style="width:70%;height:70%;border-radius:50%;background:rgba(155,93,229,0.3);border:2px solid #9B5DE5;"></div>';
            } else {
                if (!trail.has(`${playerPos.x},${playerPos.y}`)) {
                    oldCell.classList.add('trail');
                    trail.add(`${playerPos.x},${playerPos.y}`);
                }
            }
        }

        // Portals
        if (t === 6 || t === 7) {
            const targetType = t === 6 ? 7 : 6;
            let tp = null;
            for (let r = 0; r < lv.h; r++) {
                for (let c = 0; c < lv.w; c++) {
                    if (mapState[r][c] === targetType) tp = {x: c, y: r};
                }
            }
            if (tp) {
                log(`Portal jump!`, 'info');
                playerPos = {x: tp.x, y: tp.y};
                const warpCell = document.getElementById(`c-${tp.x}-${tp.y}`);
                warpCell.innerHTML = '<div class="player"></div>';
                return 'ok';
            }
        }

        // Items
        if (t === 4) {
            inventory.keys++;
            mapState[ny][nx] = 0;
            log(`KEY collected! Total: ${inventory.keys}`, 'success');
        }
        if (t === 8) {
            inventory.frags++;
            mapState[ny][nx] = 0;
            log(`Data fragment acquired!`, 'success');
        }

        playerPos = {x: nx, y: ny};
        const nextCell = document.getElementById(`c-${nx}-${ny}`);
        
        if (t === 3) {
            nextCell.innerHTML = '<div class="player moving"></div>';
            nextCell.classList.add('win-flash');
            return 'win';
        }

        nextCell.innerHTML = '<div class="player"></div>';
        return 'ok';
    }

    // ─── WIN LOGIC ───
    function handleWin() {
		isPlaying = false;
		const lv = levels[gLevel];

		// 1. Calculate Stars
		const stars = calcStars(lastMoveCount, lv.optimalMoves, lv.reqRegex, editor.getValue());

		// 2. Calculate XP (Base + Stars + Fragments)
		// Note: inventory.frags is defined in your game state
		const xpGained = lv.xpBase + (stars * 20) + (inventory.frags * 15);
		totalXP += xpGained;
		
		// Update the visual XP bar
		updateXPBar(xpGained);

		// 3. Update Best Score (Local Tracker)
		// We create a unique key like 'easy_0' or 'hard_2'
		const key = diff + '_' + gLevel; 
		if (!bestScores[key] || lastMoveCount < bestScores[key]) {
			bestScores[key] = lastMoveCount;
			// Update UI immediately
			document.getElementById('stat-best').textContent = String(lastMoveCount);
		}

		// 4. Update Header Stars UI
		const starsEl = document.getElementById('stars-display');
		starsEl.querySelectorAll('.star').forEach((s, i) => {
			if (i < stars) s.classList.add('earned');
		});

		// 5. Prepare the Win Modal UI
		const winStarsEl = document.getElementById('win-stars');
		winStarsEl.querySelectorAll('.win-star').forEach((s, i) => {
			s.classList.remove('lit');
			// Add animation delay for dramatic effect
			if (i < stars) setTimeout(() => s.classList.add('lit'), i * 200);
		});
		
		document.getElementById('ws-moves').textContent = lastMoveCount;
		document.getElementById('ws-xp').textContent = '+' + xpGained;
		document.getElementById('ws-stars').textContent = '★'.repeat(stars);
		
		// If you have fragment UI in the modal, update it here
		const fragDisplay = document.getElementById('ws-frags');
		if(fragDisplay) {
			// Count total possible fragments in this map
			let totalFrags = 0;
			for(let r of lv.map) for(let c of r) if(c===8) totalFrags++;
			fragDisplay.textContent = inventory.frags + '/' + totalFrags;
		}

		// 6. ★★★ TRIGGER CLOUD SAVE ★★★
		// This calls the function we wrote above. 
		// It runs immediately after beating THIS specific level.
		if(typeof saveProgressToCloud === 'function') {
			saveProgressToCloud(); 
		}

		// 7. Show Success Message & Open Modal
		log(`Layer ${lv.layer} breached! ${xpGained} XP gained.`, 'success');
		playWin();

		setTimeout(() => {
			document.getElementById('overlay-win').style.display = 'flex';
		}, 600);
	}


    function calcStars(moves, optimal, regex, code) {
        let s = 1;
        if (regex.test(code)) s = 2;
        if (moves <= optimal * 1.2) s = 3;
        return s;
    }

    function nextLevel() {
        document.getElementById('overlay-win').style.display = 'none';
        if (diff === 'expert') {
            expertConceptIdx++;
            levels = [getExpertLevel()];
            initLevel(0);
            playStart();
        } else if (gLevel + 1 < levels.length) {
            initLevel(gLevel + 1);
            playStart();
        } else {
            log('ALL LAYERS BREACHED.', 'success');
            alert('🏆 ALL LAYERS IN THIS DIFFICULTY CLEARED!');
            document.getElementById('overlay-diff').style.display = 'flex';
        }
    }

    function resetLevel() {
        if (isPlaying) return;
        initLevel(gLevel);
        playClick();
    }

    function closeTutorial() {
        document.getElementById('overlay-tutorial').style.display = 'none';
        playClick();
    }

    // ─── TERMINAL ───
    function log(msg, type='system') {
        const term = document.getElementById('terminal');
        const line = document.createElement('div');
        line.className = 'term-line';
        line.innerHTML = `<span class="term-prompt">$</span><span class="term-msg ${type}">${msg}</span>`;
        term.appendChild(line);
        term.scrollTop = term.scrollHeight;
        // Keep terminal clean
        while (term.children.length > 30) term.removeChild(term.firstChild);
    }
	 window.addEventListener('resize', () => {
        if (levels.length > 0) renderGrid();
    });
    </script>

</body>
</html>
