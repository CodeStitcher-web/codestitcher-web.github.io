<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CodeStitcher | Neural Simulation</title>
<link rel="icon" type="image/png" href="codestitcher.png">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>
<style>
:root {
  --bg:#04050a; --s1:#080c14; --s2:#0d1220;
  --cyan:#00F0FF; --cyand:rgba(0,240,255,.12); --cyanb:rgba(0,240,255,.3);
  --gold:#FFD43B; --goldd:rgba(255,212,59,.12);
  --green:#00D26A; --greend:rgba(0,210,106,.12);
  --red:#FF3860; --redd:rgba(255,56,96,.12);
  --purple:#9B5DE5; --purpled:rgba(155,93,229,.15);
  --orange:#FF8C42; --oranged:rgba(255,140,66,.15);
  --border:rgba(0,240,255,.07); --border2:rgba(0,240,255,.2);
  --text:#cdd6e8; --textd:#3a4a60;
  --mono:'JetBrains Mono',monospace; --ui:'Outfit',sans-serif;
  --nav:54px;
  --tab:52px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--ui);display:flex;flex-direction:column;}

#bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;}

nav{
  height:var(--nav);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;
  background:rgba(4,5,10,.97);border-bottom:1px solid var(--border);
  backdrop-filter:blur(20px);position:relative;z-index:200;
}
.n-left{display:flex;align-items:center;gap:12px;}
.n-logo{display:flex;align-items:center;gap:10px;text-decoration:none;}
.n-logo img{height:34px;width:auto;}
.n-title{font-weight:800;font-size:1.05rem;color:#fff;letter-spacing:-.3px;}
.n-tag{font-family:var(--mono);font-size:.65rem;color:var(--cyan);background:var(--cyand);border:1px solid var(--cyanb);padding:2px 7px;border-radius:3px;letter-spacing:1px;}
.n-xp{display:flex;align-items:center;gap:10px;flex:1;max-width:280px;margin:0 20px;}
.n-xp-lbl{font-family:var(--mono);font-size:.65rem;color:var(--gold);white-space:nowrap;}
.xp-track{flex:1;height:3px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ff9900);border-radius:2px;width:0%;transition:width .8s cubic-bezier(.25,1,.5,1);box-shadow:0 0 8px rgba(255,212,59,.5);}
.rank-badge{font-family:var(--mono);font-size:.6rem;color:var(--gold);background:var(--goldd);border:1px solid rgba(255,212,59,.2);padding:2px 7px;border-radius:3px;white-space:nowrap;letter-spacing:1px;}
.n-right{display:flex;gap:6px;}
.nb{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:5px;font-size:.75rem;font-weight:700;text-decoration:none;border:1px solid transparent;cursor:pointer;transition:all .22s ease;white-space:nowrap;}
.nb-home{color:#7a8fa8;border-color:rgba(255,255,255,.06);background:rgba(255,255,255,.02);}
.nb-home:hover{color:#fff;border-color:rgba(255,255,255,.18);}
.nb-exit{color:var(--red);border-color:rgba(255,56,96,.2);background:var(--redd);}
.nb-exit:hover{background:var(--red);color:#fff;box-shadow:0 0 18px rgba(255,56,96,.4);}

#app{flex:1;display:flex;position:relative;z-index:10;overflow:hidden;min-height:0;}

.panel{display:flex;flex-direction:column;overflow:hidden;}
#panel-grid{width:50%;border-right:1px solid var(--border);}
#panel-code{width:50%;background:rgba(6,9,16,.98);}

.lv-header{
  height:46px;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;background:rgba(4,5,10,.95);border-bottom:1px solid var(--border);
}
.lv-info{display:flex;align-items:center;gap:10px;}
.lv-num{font-family:var(--mono);font-size:.65rem;color:var(--cyan);background:var(--cyand);border:1px solid var(--cyanb);padding:2px 8px;border-radius:3px;letter-spacing:1px;}
.lv-name{font-weight:700;font-size:.9rem;color:#fff;}
.lv-story{font-size:.72rem;color:#3a4a60;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lv-right{display:flex;align-items:center;gap:10px;}
.stars-row{display:flex;gap:3px;}
.star{font-size:.9rem;color:#1a2535;transition:all .3s ease;}
.star.on{color:var(--gold);text-shadow:0 0 10px rgba(255,212,59,.7);}
.coord-btn{font-family:var(--mono);font-size:.6rem;color:#3a4a60;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:2px 7px;border-radius:3px;cursor:pointer;transition:all .2s ease;letter-spacing:1px;}
.coord-btn:hover,.coord-btn.on{color:var(--cyan);border-color:var(--cyanb);background:var(--cyand);}

.grid-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;overflow:hidden;min-height:0;}
.col-labels{display:flex;padding-left:24px;margin-bottom:3px;gap:2px;}
.col-lbl,.row-lbl{font-family:var(--mono);font-size:9px;color:#2a3a50;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.grid-row-area{display:flex;gap:3px;}
.row-labels{display:flex;flex-direction:column;gap:2px;margin-right:3px;}
.grid-wrapper{position:relative;flex-shrink:0;}
#game-grid{display:grid;gap:2px;position:relative;z-index:5;}

.grid-cell{
  position:relative;display:flex;align-items:center;justify-content:center;
  background:rgba(8,14,28,.85);
  border:1px solid rgba(0,240,255,.13);
  border-radius:2px;overflow:visible;
  transition:background .15s ease,border-color .15s ease;
}
.grid-cell:nth-child(even){background:rgba(10,16,30,.85);}
.grid-cell::after{
  content:attr(data-coord);
  position:absolute;bottom:2px;right:3px;
  font-family:var(--mono);font-size:7px;
  color:rgba(0,240,255,.12);pointer-events:none;z-index:1;
  transition:color .2s ease;
}
.show-coords .grid-cell::after{color:rgba(0,240,255,.35);}

#player-sprite{
  position:absolute;left:0;top:0;
  transform:translate(0,0);
  transition:transform .2s cubic-bezier(.25,.46,.45,.94);
  z-index:20;pointer-events:none;
  display:flex;align-items:center;justify-content:center;
}
.player-inner{
  width:52%;height:52%;
  background:var(--cyan);
  clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%);
  box-shadow:0 0 18px var(--cyan),0 0 35px rgba(0,240,255,.3);
  animation:pulsePl 2s ease-in-out infinite;
}
@keyframes pulsePl{0%,100%{box-shadow:0 0 12px var(--cyan),0 0 25px rgba(0,240,255,.2);}50%{box-shadow:0 0 24px var(--cyan),0 0 50px rgba(0,240,255,.5);}}
#player-sprite.is-moving .player-inner{animation:none;box-shadow:0 0 30px var(--cyan),0 0 60px rgba(0,240,255,.6);}
#player-sprite.shake{animation:shakeAnim .4s ease;}
@keyframes shakeAnim{0%,100%{transform:translate(var(--tx),var(--ty)) rotate(0);}25%{transform:translate(calc(var(--tx) - 5px),var(--ty)) rotate(-5deg);}75%{transform:translate(calc(var(--tx) + 5px),var(--ty)) rotate(5deg);}50%{transform:translate(var(--tx),calc(var(--ty) - 4px)) rotate(0);}}

.ent-wall{
  position:absolute;inset:0;
  background:rgba(255,56,96,.07);border-radius:1px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,56,96,.35);
}
.ent-wall::before{content:'';position:absolute;inset:4px;border:1px solid rgba(255,56,96,.15);border-radius:1px;}
.ent-wall i{color:var(--red);font-size:.8rem;animation:flick 3s ease infinite;}
@keyframes flick{0%,100%{opacity:.5;}50%{opacity:.9;}}

.ent-goal{
  width:56%;height:56%;background:var(--gold);border-radius:3px;
  box-shadow:0 0 15px var(--gold),0 0 30px rgba(255,212,59,.3);
  animation:spinGoal 3s linear infinite;position:relative;
}
.ent-goal::after{content:'';position:absolute;inset:-5px;border:1px solid rgba(255,212,59,.25);border-radius:4px;animation:goalAura 2s ease infinite;}
@keyframes spinGoal{to{transform:rotate(45deg);}}
@keyframes goalAura{0%,100%{transform:scale(1);opacity:.5;}50%{transform:scale(1.4);opacity:0;}}

.ent-key{width:62%;height:62%;display:flex;align-items:center;justify-content:center;color:var(--cyan);font-size:1.1rem;filter:drop-shadow(0 0 8px var(--cyan));animation:keyFloat 2s ease infinite;}
@keyframes keyFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}

.ent-door{position:absolute;inset:2px;background:rgba(255,140,66,.08);border:1px solid rgba(255,140,66,.5);border-radius:2px;display:flex;align-items:center;justify-content:center;}
.ent-door i{color:var(--orange);font-size:.95rem;}

.ent-portal{width:64%;height:64%;border-radius:50%;border:2px solid var(--purple);background:var(--purpled);display:flex;align-items:center;justify-content:center;animation:portalSpin 4s linear infinite;box-shadow:0 0 12px var(--purple),inset 0 0 10px rgba(155,93,229,.2);}
@keyframes portalSpin{to{transform:rotate(360deg);}}
.ent-portal::before{content:'';width:40%;height:40%;background:var(--purple);border-radius:50%;opacity:.7;}

.ent-frag{width:12px;height:12px;background:var(--green);clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);box-shadow:0 0 10px var(--green);animation:fragPulse 1.5s ease infinite;}
@keyframes fragPulse{0%,100%{box-shadow:0 0 6px var(--green);}50%{box-shadow:0 0 18px var(--green);}}

.grid-cell.trail-cell{background:rgba(0,240,255,.06)!important;border-color:rgba(0,240,255,.2)!important;}
.grid-cell.wall-hit{animation:wallHit .45s ease!important;}
@keyframes wallHit{0%,100%{background:rgba(8,14,28,.85);}40%{background:rgba(255,56,96,.3);border-color:rgba(255,56,96,.8);}}
.grid-cell.key-pick{animation:keyPick .4s ease!important;}
@keyframes keyPick{0%{background:rgba(8,14,28,.85);}50%{background:rgba(0,240,255,.25);}100%{background:rgba(8,14,28,.85);}}
.grid-cell.door-open{animation:doorOpen .5s ease!important;}
@keyframes doorOpen{0%{background:rgba(255,140,66,.15);}50%{background:rgba(0,210,106,.25);}100%{background:rgba(8,14,28,.85);}}
.grid-cell.frag-pick{animation:fragPick .4s ease!important;}
@keyframes fragPick{50%{background:rgba(0,210,106,.25);}}
.grid-cell.warp-cell{animation:warpCell .5s ease!important;}
@keyframes warpCell{0%,100%{background:rgba(8,14,28,.85);}50%{background:rgba(155,93,229,.3);border-color:rgba(155,93,229,.8);}}

.trail-dot{position:absolute;z-index:8;border-radius:2px;pointer-events:none;background:rgba(0,240,255,.15);border:1px solid rgba(0,240,255,.1);animation:trailFade 1.2s ease forwards;}
@keyframes trailFade{0%{opacity:.8;}100%{opacity:0;}}

.win-particle{position:absolute;z-index:30;border-radius:50%;width:6px;height:6px;pointer-events:none;animation:particleBurst .9s ease-out forwards;}
@keyframes particleBurst{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--pdx),var(--pdy)) scale(.2);}}

.hud-bar{height:40px;flex-shrink:0;background:rgba(4,5,10,.95);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:18px;overflow-x:auto;}
.hud-stat{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.hud-icon{font-size:.7rem;}
.hud-lbl{font-family:var(--mono);font-size:.6rem;color:#2a3a50;letter-spacing:1px;}
.hud-val{font-family:var(--mono);font-size:.72rem;font-weight:700;}
.hud-val.c{color:var(--cyan);}
.hud-val.g{color:var(--gold);}
.hud-val.gr{color:var(--green);}
.hud-val.o{color:var(--orange);}
.hud-val.p{color:var(--purple);}
.hud-val.r{color:var(--red);}
.hud-sep{width:1px;height:20px;background:rgba(255,255,255,.05);flex-shrink:0;}
#limit-bar{margin-left:auto;display:flex;align-items:center;gap:8px;}
.limit-track{width:100px;height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;}
.limit-fill{height:100%;border-radius:3px;background:var(--green);transition:width .3s ease,background .3s ease;}

.mission-bar{height:38px;flex-shrink:0;background:rgba(4,5,10,.95);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 14px;}
.m-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 7px var(--green);animation:mBlink 2s ease infinite;}
@keyframes mBlink{0%,100%{opacity:1;}50%{opacity:.3;}}
.m-text{font-family:var(--mono);font-size:.65rem;color:#3a4a60;letter-spacing:1px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.m-req{font-family:var(--mono);font-size:.65rem;color:var(--gold);background:var(--goldd);border:1px solid rgba(255,212,59,.15);padding:2px 8px;border-radius:3px;white-space:nowrap;letter-spacing:.5px;flex-shrink:0;}
#monaco-editor{flex:1;min-height:0;}
.ctrl-bar{height:50px;flex-shrink:0;background:rgba(4,5,10,.95);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 14px;gap:10px;}
.cs-stats{display:flex;gap:12px;}
.cs-stat{font-family:var(--mono);font-size:.62rem;display:flex;align-items:center;gap:4px;}
.cs-ico{color:#2a3a50;}
.cs-val{color:var(--cyan);font-weight:700;}
.ctrl-btns{display:flex;gap:8px;align-items:center;}
.btn-reset{width:34px;height:34px;border-radius:50%;background:rgba(0,240,255,.04);border:1px solid rgba(0,240,255,.18);color:var(--cyan);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;font-size:.78rem;}
.btn-reset:hover{background:var(--cyan);color:#000;transform:rotate(180deg);box-shadow:0 0 18px rgba(0,240,255,.4);}
.btn-run{display:flex;align-items:center;gap:7px;padding:8px 18px;border-radius:5px;background:var(--green);color:#000;font-family:var(--mono);font-weight:700;font-size:.75rem;letter-spacing:1px;border:none;cursor:pointer;transition:all .22s ease;}
.btn-run:hover{box-shadow:0 0 22px rgba(0,210,106,.5);transform:translateY(-1px);}
.btn-run:disabled{opacity:.35;cursor:not-allowed;transform:none;box-shadow:none;}

#terminal{height:110px;flex-shrink:0;background:#030508;border-top:1px solid var(--border);padding:10px 14px;font-family:var(--mono);font-size:.72rem;overflow-y:auto;line-height:1.7;}
#terminal::-webkit-scrollbar{width:3px;}
#terminal::-webkit-scrollbar-thumb{background:rgba(0,240,255,.15);border-radius:2px;}
.tl{display:flex;gap:7px;align-items:flex-start;}
.tp{color:var(--cyan);opacity:.4;flex-shrink:0;}
.tm{color:#3a4a60;}
.tm.s{color:var(--green);}
.tm.e{color:var(--red);}
.tm.w{color:var(--gold);}
.tm.i{color:var(--cyan);}
.tm.p{color:var(--purple);}

.modal{position:fixed;inset:0;z-index:2000;background:rgba(4,5,10,.97);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;padding:20px;}
.modal-card{background:var(--s1);border-radius:12px;width:100%;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.6);}

#modal-loader .modal-card{max-width:360px;padding:48px 40px;text-align:center;border:1px solid var(--border);}
.loader-ring{width:52px;height:52px;margin:0 auto 20px;border:2px solid rgba(0,240,255,.1);border-top-color:var(--cyan);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loader-t{font-family:var(--mono);font-size:.85rem;color:var(--cyan);letter-spacing:2px;}
.loader-s{font-family:var(--mono);font-size:.68rem;color:#2a3a50;margin-top:6px;letter-spacing:1px;}
.loader-progress{margin-top:16px;height:3px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;}
.loader-progress-fill{height:100%;background:var(--cyan);border-radius:2px;transition:width .4s ease;box-shadow:0 0 8px var(--cyan);}

#modal-diff .modal-card{max-width:620px;border:1px solid rgba(0,240,255,.12);}
.diff-head{padding:28px 28px 20px;border-bottom:1px solid var(--border);}
.diff-head h1{font-family:var(--mono);font-size:1.1rem;color:#fff;letter-spacing:2px;}
.diff-head p{color:#3a4a60;font-size:.78rem;margin-top:5px;}
.diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:20px 28px 28px;}
.diff-btn{padding:18px 16px;border-radius:8px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .25s ease;text-align:center;}
.diff-btn:hover{transform:translateY(-2px);}
.diff-icon{font-size:1.8rem;}
.diff-name{font-family:var(--mono);font-size:.8rem;font-weight:700;letter-spacing:1px;}
.diff-sub{font-size:.7rem;color:#3a4a60;letter-spacing:.5px;}
.diff-btn.easy{border-color:rgba(0,210,106,.25);}.diff-btn.easy:hover{background:rgba(0,210,106,.08);border-color:var(--green);}.diff-btn.easy .diff-icon,.diff-btn.easy .diff-name{color:var(--green);}
.diff-btn.medium{border-color:rgba(0,240,255,.25);}.diff-btn.medium:hover{background:var(--cyand);border-color:var(--cyan);}.diff-btn.medium .diff-icon,.diff-btn.medium .diff-name{color:var(--cyan);}
.diff-btn.hard{border-color:rgba(255,212,59,.25);}.diff-btn.hard:hover{background:var(--goldd);border-color:var(--gold);}.diff-btn.hard .diff-icon,.diff-btn.hard .diff-name{color:var(--gold);}
.diff-btn.expert{border-color:rgba(255,56,96,.25);}.diff-btn.expert:hover{background:var(--redd);border-color:var(--red);}.diff-btn.expert .diff-icon,.diff-btn.expert .diff-name{color:var(--red);}

#modal-tut .modal-card{max-width:540px;border:1px solid rgba(0,240,255,.15);}
.tut-head{padding:24px 28px 18px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(0,240,255,.03),transparent);}
.tut-head h1{font-family:var(--mono);font-size:1.05rem;color:#fff;letter-spacing:2px;}
.tut-head p{color:#3a4a60;font-size:.78rem;margin-top:5px;line-height:1.6;}
.tut-body{padding:20px 28px;}
.leg-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.leg-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:7px;}
.leg-ico{width:32px;height:32px;border-radius:5px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem;}
.leg-txt strong{display:block;color:#fff;font-size:.78rem;font-weight:700;}
.leg-txt span{color:#3a4a60;font-size:.68rem;}
.tut-foot{padding:16px 28px 24px;border-top:1px solid var(--border);display:flex;justify-content:center;}
.btn-start{display:flex;align-items:center;gap:8px;padding:10px 28px;border-radius:5px;background:var(--cyand);border:1px solid var(--cyanb);color:var(--cyan);font-family:var(--mono);font-weight:700;font-size:.78rem;letter-spacing:1px;cursor:pointer;transition:all .25s ease;}
.btn-start:hover{background:var(--cyan);color:#000;box-shadow:0 0 35px rgba(0,240,255,.4);}

#modal-win .modal-card{max-width:420px;border:1px solid rgba(0,210,106,.2);text-align:center;}
.win-head{padding:28px 28px 16px;background:linear-gradient(135deg,rgba(0,210,106,.04),transparent);}
.win-icon-big{font-size:2.5rem;color:var(--green);margin-bottom:8px;}
.win-title{font-family:var(--mono);font-size:1.3rem;font-weight:900;color:#fff;letter-spacing:2px;background:linear-gradient(to bottom,#fff,var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.win-sub{color:#2a3a50;font-size:.7rem;letter-spacing:3px;margin-top:5px;font-family:var(--mono);}
.win-stars-row{display:flex;justify-content:center;gap:10px;padding:16px;}
.ws{font-size:1.6rem;color:#111825;transition:all .4s ease;}
.ws.on{color:var(--gold);text-shadow:0 0 18px rgba(255,212,59,.7);}
.win-stats{display:flex;justify-content:center;gap:24px;padding:14px 28px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.wst{text-align:center;}
.wst-v{font-family:var(--mono);font-size:1.2rem;font-weight:900;color:var(--gold);}
.wst-l{font-size:.6rem;color:#2a3a50;letter-spacing:2px;margin-top:2px;}
.win-foot{padding:16px 28px 24px;display:flex;justify-content:center;}
.btn-next{display:inline-flex;align-items:center;gap:8px;padding:10px 28px;border-radius:5px;background:rgba(0,210,106,.08);border:1px solid rgba(0,210,106,.3);color:var(--green);font-family:var(--mono);font-weight:700;font-size:.78rem;letter-spacing:1px;cursor:pointer;transition:all .25s ease;}
.btn-next:hover{background:var(--green);color:#000;box-shadow:0 0 35px rgba(0,210,106,.4);}

#modal-crash .modal-card{max-width:360px;border:1px solid rgba(255,56,96,.2);text-align:center;padding:36px 28px;}
.crash-icon{font-size:2.5rem;color:var(--red);margin-bottom:12px;}
.crash-title{font-family:var(--mono);font-size:1.1rem;font-weight:900;color:var(--red);letter-spacing:2px;}
.crash-msg{color:#3a4a60;font-size:.78rem;margin-top:8px;line-height:1.6;}
.crash-btns{display:flex;gap:10px;justify-content:center;margin-top:20px;}
.btn-retry{display:inline-flex;align-items:center;gap:7px;padding:9px 20px;border-radius:5px;background:var(--redd);border:1px solid rgba(255,56,96,.3);color:var(--red);font-family:var(--mono);font-weight:700;font-size:.75rem;letter-spacing:1px;cursor:pointer;transition:all .25s ease;}
.btn-retry:hover{background:var(--red);color:#fff;}

.xp-popup{position:fixed;top:62px;right:16px;z-index:5000;font-family:var(--mono);font-size:.78rem;font-weight:700;color:var(--gold);padding:6px 14px;border-radius:4px;background:rgba(255,212,59,.1);border:1px solid rgba(255,212,59,.3);letter-spacing:1px;pointer-events:none;animation:xpFloat 2.5s ease forwards;}
@keyframes xpFloat{0%{opacity:0;transform:translateY(0);}20%{opacity:1;}80%{opacity:1;transform:translateY(-28px);}100%{opacity:0;transform:translateY(-45px);}}

#mobile-tabs{display:none;height:var(--tab);background:rgba(4,5,10,.98);border-top:1px solid var(--border);z-index:300;flex-shrink:0;}
.mob-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;border:none;background:transparent;color:#3a4a60;font-family:var(--mono);font-size:.55rem;letter-spacing:1px;transition:all .2s ease;padding:8px;}
.mob-tab i{font-size:1rem;}
.mob-tab.active{color:var(--cyan);}
.mob-tab.active i{text-shadow:0 0 10px var(--cyan);}
.mob-run-wrap{flex:1;display:flex;align-items:center;justify-content:center;}
.mob-run{width:46px;height:46px;border-radius:50%;background:var(--green);border:none;color:#000;font-size:1.1rem;cursor:pointer;box-shadow:0 0 20px rgba(0,210,106,.4);display:flex;align-items:center;justify-content:center;transition:all .2s ease;}
.mob-run:active{transform:scale(.92);}

@media(max-width:768px){
  :root{--nav:50px;}
  nav{padding:0 12px;}
  .n-xp,.n-title,.nb span{display:none;}
  .n-tag{display:none;}
  #app{position:absolute;top:var(--nav);left:0;right:0;bottom:var(--tab);}
  .panel{position:absolute;inset:0;display:none;}
  .panel.active{display:flex;}
  #panel-grid.active,#panel-code.active{width:100%;}
  #mobile-tabs{display:flex;}
  .lv-story{display:none;}
  .hud-bar{gap:12px;}
  .hud-lbl{display:none;}
  .diff-grid{grid-template-columns:1fr 1fr;}
  .leg-grid{grid-template-columns:1fr;}
  #terminal{height:90px;}
  .ctrl-bar{padding:0 10px;}
}
@media(max-width:480px){
  .diff-grid{grid-template-columns:1fr;}
  .n-logo img{height:28px;}
}
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<nav>
  <div class="n-left">
    <a href="index.html" class="n-logo">
      <img src="codestitcher.png" alt="CS" onerror="this.style.display='none'">
      <span class="n-title">CodeStitcher</span>
    </a>
    <span class="n-tag">// NEURAL SIM</span>
  </div>
  <div class="n-xp">
    <span class="n-xp-lbl" id="xp-lbl">XP: 0</span>
    <div class="xp-track"><div class="xp-fill" id="xp-fill"></div></div>
    <span class="rank-badge" id="rank-badge">NOVICE</span>
  </div>
  <div class="n-right">
    <a href="index.html" class="nb nb-home"><i class="fa-solid fa-house"></i> <span>Home</span></a>
    <a href="python-lab.html" class="nb nb-exit"><i class="fa-solid fa-power-off"></i> <span>Exit</span></a>
  </div>
</nav>

<div id="app">
  <div class="panel" id="panel-grid">
    <div class="lv-header">
      <div class="lv-info">
        <span class="lv-num" id="lv-num">LAYER E1</span>
        <div>
          <div class="lv-name" id="lv-name">Motor Control</div>
          <div class="lv-story" id="lv-story">Navigate the neural lattice</div>
        </div>
      </div>
      <div class="lv-right">
        <div class="stars-row" id="stars-row">
          <span class="star">‚òÖ</span><span class="star">‚òÖ</span><span class="star">‚òÖ</span>
        </div>
        <button class="coord-btn" id="coord-btn" onclick="toggleCoords()">‚äû COORDS</button>
      </div>
    </div>
    <div class="grid-area" id="grid-area">
      <div class="col-labels" id="col-labels"></div>
      <div class="grid-row-area">
        <div class="row-labels" id="row-labels"></div>
        <div class="grid-wrapper" id="grid-wrapper">
          <div id="game-grid"></div>
          <div id="player-sprite"><div class="player-inner"></div></div>
        </div>
      </div>
    </div>
    <div class="hud-bar">
      <div class="hud-stat"><span class="hud-icon" style="color:var(--cyan)">‚óà</span><span class="hud-lbl">MOVES</span><span class="hud-val c" id="h-moves">0</span></div>
      <div class="hud-sep"></div>
      <div class="hud-stat"><span class="hud-icon" style="color:var(--gold)">‚äõ</span><span class="hud-lbl">BEST</span><span class="hud-val g" id="h-best">‚Äî</span></div>
      <div class="hud-sep"></div>
      <div class="hud-stat"><span class="hud-icon" style="color:var(--green)">‚óâ</span><span class="hud-lbl">LAYER</span><span class="hud-val gr" id="h-layer">1/5</span></div>
      <div class="hud-sep"></div>
      <div class="hud-stat"><span class="hud-icon" style="color:var(--cyan)">‚¨ü</span><span class="hud-lbl">KEYS</span><span class="hud-val c" id="h-keys">0</span></div>
      <div class="hud-sep"></div>
      <div class="hud-stat"><span class="hud-icon" style="color:var(--green)">‚òÖ</span><span class="hud-lbl">FRAGS</span><span class="hud-val gr" id="h-frags">0</span></div>
      <div id="limit-bar">
        <span class="hud-lbl">LIMIT</span>
        <span class="hud-val" id="h-limit" style="color:var(--green)">‚àû</span>
        <div class="limit-track" id="limit-track" style="display:none">
          <div class="limit-fill" id="limit-fill"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-code">
    <div class="mission-bar">
      <div class="m-dot"></div>
      <span class="m-text" id="m-text">AGENT UPLINK ACTIVE</span>
      <span class="m-req" id="m-req">‚Äî</span>
    </div>
    <div id="monaco-editor"></div>
    <div class="ctrl-bar">
      <div class="cs-stats">
        <div class="cs-stat"><span class="cs-ico"><i class="fa-solid fa-code"></i></span><span style="color:#2a3a50;font-size:.6rem">LINES</span><span class="cs-val" id="cs-lines">‚Äî</span></div>
        <div class="cs-stat"><span class="cs-ico"><i class="fa-solid fa-bolt"></i></span><span style="color:#2a3a50;font-size:.6rem">CONCEPTS</span><span class="cs-val" id="cs-conc">‚Äî</span></div>
      </div>
      <div class="ctrl-btns">
        <button class="btn-reset" onclick="resetLevel()" title="Reset"><i class="fa-solid fa-arrows-rotate"></i></button>
        <button class="btn-run" id="run-btn" onclick="runCode()"><i class="fa-solid fa-play"></i> EXECUTE</button>
      </div>
    </div>
    <div id="terminal">
      <div class="tl"><span class="tp">$</span><span class="tm i">Neural Simulation v3.0 ‚Äî Loading Python engine...</span></div>
    </div>
  </div>
</div>

<div id="mobile-tabs">
  <button class="mob-tab active" id="tab-grid" onclick="switchTab('grid')">
    <i class="fa-solid fa-table-cells-large"></i> GRID
  </button>
  <div class="mob-run-wrap">
    <button class="mob-run" onclick="runCode()"><i class="fa-solid fa-play"></i></button>
  </div>
  <button class="mob-tab" id="tab-code" onclick="switchTab('code')">
    <i class="fa-solid fa-code"></i> CODE
  </button>
</div>

<!-- MODAL: DIFFICULTY -->
<div class="modal" id="modal-diff" style="display:none">
  <div class="modal-card">
    <div class="diff-head">
      <h1>SELECT PROTOCOL</h1>
      <p>Choose your breach difficulty. Each level teaches a new Python concept.</p>
    </div>
    <div class="diff-grid">
      <button class="diff-btn easy" onclick="selectDiff('easy')">
        <span class="diff-icon">‚óà</span>
        <span class="diff-name">EASY</span>
        <span class="diff-sub">6√ó6 ¬∑ No limit ¬∑ Basic</span>
      </button>
      <button class="diff-btn medium" onclick="selectDiff('medium')">
        <span class="diff-icon">‚¨°</span>
        <span class="diff-name">MEDIUM</span>
        <span class="diff-sub">8√ó8 ¬∑ Standard ¬∑ Loops</span>
      </button>
      <button class="diff-btn hard" onclick="selectDiff('hard')">
        <span class="diff-icon">‚äõ</span>
        <span class="diff-name">HARD</span>
        <span class="diff-sub">12√ó12 ¬∑ Keys ¬∑ Portals ¬∑ Limits</span>
      </button>
      <button class="diff-btn expert" onclick="selectDiff('expert')">
        <span class="diff-icon">‚àû</span>
        <span class="diff-name">EXPERT</span>
        <span class="diff-sub">Procedural ¬∑ Endless ¬∑ Master</span>
      </button>
    </div>
  </div>
</div>

<!-- MODAL: TUTORIAL -->
<div class="modal" id="modal-tut" style="display:none">
  <div class="modal-card">
    <div class="tut-head">
      <h1>MISSION BRIEFING</h1>
      <p>You are <strong style="color:var(--cyan)">A1-Agent</strong> ‚Äî an AI escaping a corrupted system. Write Python to navigate security layers and reach the Quantum Node.</p>
    </div>
    <div class="tut-body">
      <div class="leg-grid">
        <div class="leg-item"><div class="leg-ico" style="background:rgba(0,240,255,.1)">‚óà</div><div class="leg-txt"><strong>A1-Agent</strong><span>Your avatar. Move with code.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(255,212,59,.1)">‚äõ</div><div class="leg-txt"><strong>Quantum Node</strong><span>The goal. Reach it.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(255,56,96,.1)">‚úï</div><div class="leg-txt"><strong>Firewall</strong><span>Fatal. Triggers crash.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(0,240,255,.1)">üîë</div><div class="leg-txt"><strong>Key</strong><span>Collect to unlock doors.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(255,140,66,.1)">üö™</div><div class="leg-txt"><strong>Locked Door</strong><span>Needs a key to pass.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(155,93,229,.1)">‚äö</div><div class="leg-txt"><strong>Portal</strong><span>Teleports you to pair.</span></div></div>
        <div class="leg-item"><div class="leg-ico" style="background:rgba(0,210,106,.1)">‚òÖ</div><div class="leg-txt"><strong>Data Fragment</strong><span>Collect for bonus XP.</span></div></div>
        <div class="leg-item" style="border-color:rgba(0,210,106,.15);background:rgba(0,210,106,.04)"><div class="leg-ico" style="background:rgba(0,210,106,.1);color:var(--green);font-size:.8rem">{ }</div><div class="leg-txt"><strong>Command</strong><span style="font-family:var(--mono);color:var(--cyan);font-size:.65rem">agent.move("right",3)</span></div></div>
      </div>
    </div>
    <div class="tut-foot">
      <button class="btn-start" onclick="closeTut()">INITIALIZE UPLINK <i class="fa-solid fa-bolt"></i></button>
    </div>
  </div>
</div>

<!-- MODAL: WIN -->
<div class="modal" id="modal-win" style="display:none">
  <div class="modal-card">
    <div class="win-head">
      <div class="win-icon-big"><i class="fa-solid fa-shield-halved"></i></div>
      <div class="win-title">LAYER BREACHED</div>
      <div class="win-sub">SECURITY PROTOCOL DEFEATED</div>
    </div>
    <div class="win-stars-row" id="win-stars">
      <span class="ws">‚òÖ</span><span class="ws">‚òÖ</span><span class="ws">‚òÖ</span>
    </div>
    <div class="win-stats">
      <div class="wst"><div class="wst-v" id="ws-moves">‚Äî</div><div class="wst-l">MOVES</div></div>
      <div class="wst"><div class="wst-v" id="ws-xp">‚Äî</div><div class="wst-l">XP GAINED</div></div>
      <div class="wst"><div class="wst-v" id="ws-frags">‚Äî</div><div class="wst-l">FRAGMENTS</div></div>
    </div>
    <div class="win-foot">
      <button class="btn-next" onclick="nextLevel()">NEXT LAYER <i class="fa-solid fa-forward"></i></button>
    </div>
  </div>
</div>

<!-- MODAL: CRASH -->
<div class="modal" id="modal-crash" style="display:none">
  <div class="modal-card">
    <div class="crash-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
    <div class="crash-title">SYSTEM CRASH</div>
    <div class="crash-msg" id="crash-msg">Agent hit a firewall. Connection severed.</div>
    <div class="crash-btns">
      <button class="btn-retry" onclick="dismissCrash()"><i class="fa-solid fa-arrows-rotate"></i> RETRY</button>
    </div>
  </div>
</div>

<!-- MODAL: LOADER -->
<div class="modal" id="modal-loader">
  <div class="modal-card">
    <div class="loader-ring"></div>
    <div class="loader-t" id="loader-t">INITIALIZING</div>
    <div class="loader-s" id="loader-s">Loading Python engine...</div>
    <div class="loader-progress"><div class="loader-progress-fill" id="loader-progress-fill" style="width:0%"></div></div>
  </div>
</div>

<!-- Load Pyodide from CDN -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BACKGROUND CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(()=>{
  const C=document.getElementById('bg-canvas');
  const X=C.getContext('2d');
  let W,H,pts=[];
  const resize=()=>{W=C.width=window.innerWidth;H=C.height=window.innerHeight;};
  class P{constructor(){this.reset();}reset(){this.x=Math.random()*W;this.y=Math.random()*H;this.vx=(Math.random()-.5)*.25;this.vy=(Math.random()-.5)*.25;this.r=Math.random()*.9+.3;}}
  const init=()=>{resize();pts=Array.from({length:70},()=>new P());};
  const draw=()=>{
    X.clearRect(0,0,W,H);
    for(let i=0;i<pts.length;i++){
      const a=pts[i];a.x+=a.vx;a.y+=a.vy;
      if(a.x<0||a.x>W)a.vx*=-1;if(a.y<0||a.y>H)a.vy*=-1;
      for(let j=i+1;j<pts.length;j++){
        const b=pts[j],dx=a.x-b.x,dy=a.y-b.y,d=Math.sqrt(dx*dx+dy*dy);
        if(d<120){X.beginPath();X.moveTo(a.x,a.y);X.lineTo(b.x,b.y);X.strokeStyle=`rgba(0,240,255,${.03*(1-d/120)})`;X.lineWidth=.4;X.stroke();}
      }
      X.beginPath();X.arc(a.x,a.y,a.r,0,Math.PI*2);X.fillStyle='rgba(93,95,239,.55)';X.fill();
    }
    requestAnimationFrame(draw);
  };
  window.addEventListener('resize',init);init();draw();
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AX=new(window.AudioContext||window.webkitAudioContext)();
const resume=()=>{if(AX.state==='suspended')AX.resume();};
function beep(f,t,d,v=.07,type='sine'){
  resume();
  const o=AX.createOscillator(),g=AX.createGain();
  o.connect(g);g.connect(AX.destination);
  o.type=type;o.frequency.value=f;
  g.gain.setValueAtTime(v,AX.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,AX.currentTime+d);
  o.start(AX.currentTime+t);o.stop(AX.currentTime+t+d);
}
const snd={
  click:()=>beep(900,'sine',.08,.04),
  move:()=>beep(660,'sine',.09,.03),
  collect:()=>{beep(880,.0,.15,.06);beep(1100,.12,.15,.05);},
  teleport:()=>{beep(400,'square',.05,.07);beep(900,'sine',.2,.06);},
  unlock:()=>{beep(550,.0,.2,.07);beep(770,.15,.2,.06);},
  error:()=>beep(180,'sawtooth',.3,.06),
  win:()=>{[500,700,900,1200].forEach((f,i)=>setTimeout(()=>beep(f,'sine',.4,.08),i*100));},
  start:()=>beep(440,'triangle',.3,.05),
  crash:()=>{beep(200,'sawtooth',.1,.08);beep(150,'sawtooth',.3,.06);}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RANKS & XP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RANKS=[
  {name:'NOVICE',xp:0},{name:'INITIATE',xp:80},{name:'DEVELOPER',xp:200},
  {name:'ARCHITECT',xp:400},{name:'HACKER',xp:700},{name:'GRANDMASTER',xp:1000}
];
let totalXP=0;
function getRank(xp){
  for(let i=RANKS.length-1;i>=0;i--)if(xp>=RANKS[i].xp)return{cur:RANKS[i],next:RANKS[i+1]||null};
  return{cur:RANKS[0],next:RANKS[1]};
}
function updateXPBar(gained=0){
  const{cur,next}=getRank(totalXP);
  const pct=next?((totalXP-cur.xp)/(next.xp-cur.xp))*100:100;
  document.getElementById('xp-fill').style.width=pct+'%';
  document.getElementById('xp-lbl').textContent='XP: '+totalXP;
  document.getElementById('rank-badge').textContent=cur.name;
  if(gained>0){
    const p=document.createElement('div');p.className='xp-popup';
    p.textContent='+'+gained+' XP';document.body.appendChild(p);
    setTimeout(()=>p.remove(),2600);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEVEL DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEVELS={
  easy:[
    {
      layer:'E1',name:'Motor Control',story:'Basic navigation. Move down to the Quantum Node.',
      concept:'agent.move()',reqText:'Call agent.move()',reqRegex:/move/,
      optMoves:5,moveLimit:-1,xpBase:30,w:6,h:6,
      map:[[2,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]],
      code:`import agent\n\n# Layer E1: Motor Control\n# Move to the yellow Quantum Node!\n# Use: agent.move(direction, steps)\n\nagent.move("down", 5)\nagent.move("right", 5)\n`
    },
    {
      layer:'E2',name:'Memory Allocation',story:'Store step counts in variables.',
      concept:'Variables',reqText:'Define a variable (x = ...)',reqRegex:/[a-zA-Z_]\w*\s*=\s*\d/,
      optMoves:9,moveLimit:-1,xpBase:40,w:6,h:6,
      map:[[2,0,0,0,0,0],[0,1,1,1,1,0],[0,0,0,0,0,0],[0,1,1,1,1,0],[0,0,0,0,0,0],[0,0,0,0,0,3]],
      code:`import agent\n\n# Layer E2: Memory Allocation\n# Use variables to navigate the corridor.\n\nsteps_right = 5\nsteps_down = 2\n\nagent.move("right", steps_right)\nagent.move("down", steps_down)\nagent.move("left", steps_right)\nagent.move("down", steps_down)\nagent.move("right", steps_right)\n`
    },
    {
      layer:'E3',name:'Iteration Protocol',story:'Loops defeat diagonal obstacles.',
      concept:'for loops',reqText:'Use a for loop',reqRegex:/for\s+\w+\s+in/,
      optMoves:10,moveLimit:-1,xpBase:50,w:6,h:6,
      map:[[2,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,3]],
      code:`import agent\n\n# Layer E3: Iteration Protocol\n# Use a loop to navigate the diagonal.\n\nfor i in range(5):\n    agent.move("right", 1)\n    agent.move("down", 1)\n`
    },
    {
      layer:'E4',name:'Functional Abstraction',story:'Define reusable move routines.',
      concept:'def functions',reqText:'Define a function (def)',reqRegex:/def\s+\w+\(/,
      optMoves:12,moveLimit:-1,xpBase:60,w:6,h:6,
      map:[[2,0,0,0,0,0],[0,1,0,1,0,0],[0,1,0,1,0,0],[0,1,0,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,3]],
      code:`import agent\n\n# Layer E4: Functional Abstraction\n# Define a function to clean your code.\n\ndef go(d, n):\n    agent.move(d, n)\n\ngo("down", 4)\ngo("right", 5)\n`
    },
    {
      layer:'E5',name:'Data Structures',story:'Lists carry your path data.',
      concept:'Lists []',reqText:'Use a list [ ]',reqRegex:/\[.*\]/,
      optMoves:10,moveLimit:-1,xpBase:70,w:6,h:6,
      map:[[2,0,0,3,0,0],[0,1,1,0,1,1],[0,0,0,0,0,0],[1,1,0,1,1,0],[0,0,0,0,0,0],[0,0,0,0,0,0]],
      code:`import agent\n\n# Layer E5: Data Structures\n# Use a list to store your path.\n\npath = ["right", "right", "right"]\n\nfor d in path:\n    agent.move(d, 1)\n`
    }
  ],
  medium:[
    {
      layer:'M1',name:'Variable Routes',story:'Allocate memory for route data.',
      concept:'Variables',reqText:'Use at least one variable',reqRegex:/[a-zA-Z_]\w*\s*=\s*\d/,
      optMoves:14,moveLimit:-1,xpBase:60,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]],
      code:`import agent\n\n# Layer M1: Navigate using variables\n\nside = 7\n\nagent.move("right", side)\nagent.move("down", side)\n`
    },
    {
      layer:'M2',name:'Loop Descent',story:'Diagonal firewall. Use loops.',
      concept:'for loops',reqText:'Use a for loop',reqRegex:/for\s+\w+\s+in/,
      optMoves:14,moveLimit:-1,xpBase:80,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[0,1,0,0,0,0,0,0],[0,0,1,0,0,0,0,0],[0,0,0,1,0,0,0,0],[0,0,0,0,1,0,0,0],[0,0,0,0,0,1,0,0],[0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,3]],
      code:`import agent\n\n# Layer M2: Use a loop to dodge the diagonal\n\nfor _ in range(7):\n    agent.move("right", 1)\n    agent.move("down", 1)\n`
    },
    {
      layer:'M3',name:'Function Protocols',story:'Define agent subroutines.',
      concept:'def functions',reqText:'Define a function (def)',reqRegex:/def\s+\w+\(/,
      optMoves:14,moveLimit:-1,xpBase:90,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[0,1,0,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,1,0,1,0,0,0,0],[0,0,0,0,0,0,0,3]],
      code:`import agent\n\n# Layer M3: Use a function to navigate the corridors\n\ndef navigate(d, n):\n    agent.move(d, n)\n\nnavigate("down", 7)\nnavigate("right", 5)\n`
    },
    {
      layer:'M4',name:'List Pathfinder',story:'Store route instructions in a list.',
      concept:'Lists []',reqText:'Use a list [ ]',reqRegex:/\[.*\]/,
      optMoves:10,moveLimit:-1,xpBase:100,w:8,h:8,
      map:[[2,0,0,0,3,0,0,0],[0,1,1,1,0,1,1,1],[0,0,0,0,0,0,0,0],[1,1,1,0,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
      code:`import agent\n\n# Layer M4: Use a list for your path\n\npath = ["right", "right", "right", "right"]\n\nfor d in path:\n    agent.move(d, 1)\n`
    },
    {
      layer:'M5',name:'While Protocol',story:'Loop until the condition triggers.',
      concept:'while loops',reqText:'Use a while loop',reqRegex:/while\s+/,
      optMoves:7,moveLimit:-1,xpBase:110,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,1],[0,1,0,1,0,1,0,1],[0,1,0,1,0,1,0,1],[0,1,0,1,0,1,0,1],[0,1,0,1,0,1,0,1],[0,1,0,1,0,1,0,1],[3,1,0,1,0,1,0,1]],
      code:`import agent\n\n# Layer M5: Use a while loop to move\n\nsteps = 7\nwhile steps > 0:\n    agent.move("down", 1)\n    steps -= 1\n`
    },
    {
      layer:'M6',name:'Snake Descent',story:'Navigate the serpentine corridor.',
      concept:'Loops',reqText:'Use a loop',reqRegex:/for|while/,
      optMoves:20,moveLimit:-1,xpBase:120,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]],
      code:`import agent\n\n# Layer M6: Navigate the snake corridor\n\nmoves = [\n    ("right", 7), ("down", 2),\n    ("left", 7), ("down", 2),\n    ("right", 7), ("down", 2),\n]\n\nfor d, n in moves:\n    agent.move(d, n)\n`
    },
    {
      layer:'M7',name:'The Corridor',story:'Navigate the tight spiral tunnel.',
      concept:'Pathfinding',reqText:'Any valid code',reqRegex:/./,
      optMoves:14,moveLimit:-1,xpBase:130,w:8,h:8,
      map:[[1,1,1,1,1,1,1,1],[2,0,0,0,0,0,0,1],[1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1],[1,0,0,0,0,0,0,3],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1]],
      code:`import agent\n\n# Layer M7: Spiral tunnel - plan your route!\n\nagent.move("right", 6)\nagent.move("down", 2)\nagent.move("left", 5)\nagent.move("down", 2)\nagent.move("right", 6)\n`
    },
    {
      layer:'M8',name:'Grand Architect',story:'Combine all concepts for the finale.',
      concept:'All concepts',reqText:'Use loops + functions',reqRegex:/def|for|while/,
      optMoves:20,moveLimit:-1,xpBase:160,w:8,h:8,
      map:[[2,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,1],[0,0,0,0,0,0,0,0],[1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0],[0,1,0,1,0,1,0,1],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3]],
      code:`import agent\n\n# Layer M8: Grand Architect ‚Äî use all concepts!\n\ndef sweep(d, n):\n    for _ in range(n):\n        agent.move(d, 1)\n\nsweep("right", 7)\nsweep("down", 2)\nsweep("left", 7)\nsweep("down", 2)\nsweep("right", 7)\nsweep("down", 2)\n`
    }
  ],
  hard:[
    {
      layer:'H1',name:'Key Protocol',story:'Collect the KEY before you can pass the LOCKED DOOR.',
      concept:'for loops',reqText:'Use a for loop',reqRegex:/for\s+\w+\s+in/,
      optMoves:44,moveLimit:60,xpBase:180,w:12,h:12,
      map:[
        [2,0,0,0,0,0,4,0,0,0,0,0],
        [0,1,1,1,1,1,0,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,5,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,3]
      ],
      code:`import agent\n\n# Layer H1: Key Protocol\n# Collect the KEY (cyan diamond) before reaching the LOCKED DOOR (orange).\n\n# Step 1: Get the key\nfor _ in range(6):\n    agent.move("right", 1)\n\n# Step 2: Navigate via gap\nagent.move("down", 2)\nagent.move("right", 5)\nagent.move("down", 2)\nagent.move("left", 6)\n\n# Unlock the door at (5,5)\nagent.move("down", 1)\n\n# Step 3: Navigate to goal\nagent.move("down", 1)\nagent.move("left", 4)\nagent.move("down", 2)\nagent.move("right", 11)\nagent.move("down", 2)\nagent.move("left", 11)\nagent.move("down", 2)\nagent.move("right", 11)\n`
    },
    {
      layer:'H2',name:'Portal Jump',story:'Use teleport portals to cross the security grid.',
      concept:'def functions',reqText:'Define a function (def)',reqRegex:/def/,
      optMoves:26,moveLimit:40,xpBase:200,w:12,h:12,
      map:[
        [2,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,6,0,0,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,7,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,3]
      ],
      code:`import agent\n\n# Layer H2: Portal Jump\n# Portals (purple circles) teleport you to the paired portal!\n\ndef go(d, n):\n    agent.move(d, n)\n\n# Navigate to Portal A at (5,2)\ngo("right", 5)\ngo("down", 2)\n\n# TELEPORTED to Portal B at (4,8)!\n\n# Navigate from (4,8) to goal at (11,11)\ngo("right", 7)\ngo("down", 2)\ngo("left", 11)\ngo("down", 1)\ngo("right", 11)\n`
    },
    {
      layer:'H3',name:'Fragment Hunt',story:'Collect data fragments for maximum XP. Watch the move limit!',
      concept:'while loops',reqText:'Use a while loop',reqRegex:/while\s+/,
      optMoves:35,moveLimit:50,xpBase:220,w:12,h:12,
      map:[
        [2,0,0,8,0,0,0,0,0,0,0,0],
        [0,1,1,1,0,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,8,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,8,0,0,0,0,0,0,0,0],
        [0,1,1,1,0,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,3]
      ],
      code:`import agent\n\n# Layer H3: Fragment Hunt\n# Collect all 3 data fragments (‚òÖ) for max stars!\n# MOVE LIMIT: 50 ‚Äî be efficient!\n\n# Fragment 1 at (3,0)\ncount = 3\nwhile count > 0:\n    agent.move("right", 1)\n    count -= 1\n\n# Navigate down\nagent.move("down", 2)\nagent.move("right", 8)\nagent.move("down", 2)\nagent.move("left", 11)\n\n# Fragment 2 at (7,5)\nagent.move("down", 1)\nagent.move("right", 7)\nagent.move("down", 1)\n\n# Continue down\nagent.move("left", 7)\nagent.move("down", 2)\nagent.move("right", 3)\n\n# Fragment 3 at (3,8)\nagent.move("down", 1)\n\n# Go to goal\nagent.move("down", 2)\nagent.move("right", 8)\n`
    },
    {
      layer:'H4',name:'Master Protocol',story:'All mechanics active. Keys, Portals, Fragments, Limit.',
      concept:'All concepts',reqText:'Use functions + loops',reqRegex:/def|for|while/,
      optMoves:42,moveLimit:60,xpBase:260,w:12,h:12,
      map:[
        [2,0,0,0,0,4,0,0,8,0,0,0],
        [0,1,1,1,1,1,0,1,1,0,1,0],
        [0,0,0,0,0,0,0,0,0,0,1,0],
        [1,1,1,1,1,1,1,1,1,0,1,0],
        [0,0,0,0,6,0,0,0,0,0,0,0],
        [0,1,1,1,1,5,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [0,1,1,1,7,1,1,8,1,1,1,0],
        [0,0,0,0,0,0,0,0,0,0,0,0],
        [1,1,1,1,1,1,1,1,1,1,1,0],
        [0,0,0,0,0,0,0,0,8,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,3]
      ],
      code:`import agent\n\n# Layer H4: Master Protocol\n\ndef go(d, n):\n    for _ in range(n):\n        agent.move(d, 1)\n\ngo("right", 8)\ngo("left", 3)\ngo("down", 2)\ngo("right", 7)\ngo("down", 1)\ngo("left", 7)\ngo("left", 3)\ngo("down", 1)\ngo("right", 10)\ngo("down", 1)\ngo("left", 11)\ngo("down", 1)\ngo("right", 8)\ngo("right", 3)\ngo("down", 1)\n`
    }
  ]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROCEDURAL MAZE GENERATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let expertConceptIdx=0;
const EXPERT_CONCEPTS=[
  {concept:'Loops',reqText:'Use a for loop',reqRegex:/for\s+\w+\s+in/,xpBase:200,moveLimit:80,
   code:`import agent\n\n# EXPERT: Procedurally Generated Maze!\n# Explore with loops.\n\nfor _ in range(5):\n    agent.move("right", 1)\n    agent.move("down", 1)\n`},
  {concept:'Functions',reqText:'Define a function (def)',reqRegex:/def/,xpBase:200,moveLimit:80,
   code:`import agent\n\n# EXPERT: New procedural layout!\n\ndef go(d, n):\n    agent.move(d, n)\n\ngo("down", 5)\ngo("right", 5)\n`},
  {concept:'While loops',reqText:'Use a while loop',reqRegex:/while\s+/,xpBase:200,moveLimit:80,
   code:`import agent\n\n# EXPERT: Fresh maze generated!\n\nn = 7\nwhile n > 0:\n    agent.move("down", 1)\n    n -= 1\n`}
];

function genMaze(W,H){
  const g=Array.from({length:H},()=>Array(W).fill(1));
  function carve(x,y){
    const dirs=[[0,-2],[2,0],[0,2],[-2,0]].sort(()=>Math.random()-.5);
    for(const[dx,dy]of dirs){
      const nx=x+dx,ny=y+dy;
      if(nx>0&&nx<W-1&&ny>0&&ny<H-1&&g[ny][nx]===1){
        g[y+dy/2][x+dx/2]=0;g[ny][nx]=0;carve(nx,ny);
      }
    }
  }
  g[1][1]=0;carve(1,1);
  g[1][1]=2;g[H-2][W-2]=3;
  let fragCount=0;
  for(let y=1;y<H-1&&fragCount<3;y++)for(let x=1;x<W-1&&fragCount<3;x++)
    if(g[y][x]===0&&Math.random()<.04){g[y][x]=8;fragCount++;}
  return{w:W,h:H,map:g};
}

function getExpertLevel(){
  const c=EXPERT_CONCEPTS[expertConceptIdx%EXPERT_CONCEPTS.length];
  const{w,h,map}=genMaze(15,15);
  return{
    layer:'EX'+(expertConceptIdx+1),name:'Expert Maze #'+(expertConceptIdx+1),
    story:'Procedurally generated. Navigate the unknown lattice.',
    ...c,optMoves:999,w,h,map
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editor=null;
let pyodide=null;
let diff='easy',levelSet=[],gLevelIdx=0;
let playerPos={x:0,y:0},mapState=[],inventory={keys:0,frags:0};
let moveQueue=[],isPlaying=false,movesMade=0,movesLimit=-1,movesLimitOrig=-1;
let bestScores={},showCoords=false;
let CELL_SIZE=54,GAP=2;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const MOVE_DUR=210;

function currentLevel(){return levelSet[gLevelIdx];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PYODIDE INIT ‚Äî Real Python execution
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPyodide() {
  const setLoad = (t, s, pct) => {
    document.getElementById('loader-t').textContent = t;
    document.getElementById('loader-s').textContent = s;
    if (pct !== undefined) {
      document.getElementById('loader-progress-fill').style.width = pct + '%';
    }
  };

  try {
    setLoad('LOADING PYTHON ENGINE', 'Fetching Pyodide runtime (~10MB)...', 10);
    pyodide = await loadPyodide({
      indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/'
    });
    setLoad('PYTHON READY', 'Setting up agent module...', 75);

    // Moves are stored in Python list _move_log.
    // After user code runs, JS reads it via pyodide.globals.get().toJs()
    // This is the correct, reliable Pyodide pattern ‚Äî no JS callbacks needed.
    pyodide.runPython(`
import sys

_move_log = []

class _AgentModule:
    def move(self, direction, steps=1):
        direction = str(direction)
        steps = int(steps)
        if direction not in ("up", "down", "left", "right"):
            raise ValueError("Invalid direction '" + direction + "'. Use: up, down, left, right")
        if steps < 1:
            raise ValueError("Steps must be >= 1, got " + str(steps))
        _move_log.append([direction, steps])

agent = _AgentModule()
sys.modules['agent'] = agent
`);

    setLoad('ALL SYSTEMS GO', 'Neural simulation ready!', 100);
    await sleep(400);
    await initMonaco();

  } catch(e) {
    setLoad('BOOT ERROR', 'Check internet connection & reload.', 0);
    console.error(e);
    log('Failed to load Pyodide: ' + (e.message || e), 'e');
  }
}

async function initMonaco() {
  return new Promise(resolve => {
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });
    require(['vs/editor/editor.main'], () => {
      monaco.editor.defineTheme('neural', {
        base: 'vs-dark', inherit: true,
        rules: [
          { token: 'keyword', foreground: '00F0FF' },
          { token: 'string', foreground: 'FFD43B' },
          { token: 'comment', foreground: '2a3a50', fontStyle: 'italic' },
          { token: 'number', foreground: '00D26A' },
          { token: 'identifier', foreground: 'b0c8e0' },
        ],
        colors: {
          'editor.background': '#06080f', 'editor.foreground': '#b0c8e0',
          'editorLineNumber.foreground': '#1a2535', 'editorLineNumber.activeForeground': '#00F0FF',
          'editor.selectionBackground': '#00F0FF18', 'editorCursor.foreground': '#00F0FF',
          'editorIndentGuide.background': '#0d1525', 'editor.lineHighlightBackground': '#0a1020',
        }
      });
      editor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: '# Select difficulty to begin...',
        language: 'python', theme: 'neural',
        fontFamily: 'JetBrains Mono', fontSize: 13, lineHeight: 22,
        minimap: { enabled: false }, scrollBeyondLastLine: false,
        padding: { top: 12, bottom: 12 }, automaticLayout: true,
        renderLineHighlight: 'line', smoothScrolling: true,
        cursorBlinking: 'smooth', cursorSmoothCaretAnimation: 'on',
      });
      editor.onDidChangeModelContent(() => updateCodeStats());
      resolve();
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STARTUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', async () => {
  await initPyodide();
  document.getElementById('modal-loader').style.display = 'none';
  document.getElementById('modal-diff').style.display = 'flex';
  log('Python engine loaded. Real Python ‚Äî no transpiler!', 's');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIFFICULTY & LEVEL MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectDiff(d){
  diff=d;
  document.getElementById('modal-diff').style.display='none';
  document.getElementById('modal-tut').style.display='flex';
  if(d==='expert') levelSet=[getExpertLevel()];
  else levelSet=LEVELS[d];
  gLevelIdx=0;
  initLevel(0);
  log(`Protocol: ${d.toUpperCase()} selected.`,'i');
}

function closeTut(){
  document.getElementById('modal-tut').style.display='none';
  snd.click();
}

function initLevel(idx){
  if(idx>=levelSet.length){
    if(diff==='expert'){
      expertConceptIdx++;
      levelSet=[getExpertLevel()];
      idx=0;
    }else{
      log('ALL LAYERS CLEARED! You are GRANDMASTER!','s');
      alert('üèÜ ALL LAYERS CLEARED! You are GRANDMASTER!');
      return;
    }
  }
  gLevelIdx=idx;
  const lv=currentLevel();
  movesMade=0;movesLimit=lv.moveLimit;movesLimitOrig=lv.moveLimit;
  inventory={keys:0,frags:0};
  mapState=lv.map.map(r=>[...r]);

  document.getElementById('lv-num').textContent=`LAYER ${lv.layer}`;
  document.getElementById('lv-name').textContent=lv.name;
  document.getElementById('lv-story').textContent=lv.story;
  document.getElementById('h-layer').textContent=`${idx+1}/${levelSet.length}`;
  document.getElementById('m-text').textContent=lv.story;
  document.getElementById('m-req').textContent=lv.reqText;
  document.getElementById('h-best').textContent=bestScores[diff+'_'+idx]||'‚Äî';
  document.getElementById('h-keys').textContent='0';
  document.getElementById('h-frags').textContent='0';
  updateMoveCounter();
  if(editor)editor.setValue(lv.code);
  updateCodeStats();
  updateStarsDisplay(0);
  renderGrid();
  log(`Layer ${lv.layer} initialized. Concept: ${lv.concept}`,'i');
  if(lv.moveLimit>0)log(`Move limit: ${lv.moveLimit}. Plan efficiently!`,'w');
}

function updateMoveCounter(){
  document.getElementById('h-moves').textContent=movesMade;
  const limitEl=document.getElementById('h-limit');
  const track=document.getElementById('limit-track');
  const fill=document.getElementById('limit-fill');
  if(movesLimit>0){
    limitEl.textContent=movesLimit;
    track.style.display='block';
    const pct=(movesLimit/movesLimitOrig)*100;
    fill.style.width=pct+'%';
    fill.style.background=pct>50?'var(--green)':pct>25?'var(--gold)':'var(--red)';
    limitEl.style.color=pct>50?'var(--green)':pct>25?'var(--gold)':'var(--red)';
  }else{
    limitEl.textContent='‚àû';limitEl.style.color='var(--green)';
    track.style.display='none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GRID RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcCellSize(){
  const area=document.getElementById('grid-area');
  const lv=currentLevel();
  const aw=area.clientWidth-50,ah=area.clientHeight-50;
  const cs=Math.min(
    Math.floor((aw-GAP*(lv.w-1))/lv.w),
    Math.floor((ah-GAP*(lv.h-1))/lv.h),
    60
  );
  return Math.max(cs,24);
}

function renderGrid(){
  if(!currentLevel())return;
  const lv=currentLevel();
  CELL_SIZE=calcCellSize();

  const colEl=document.getElementById('col-labels');
  colEl.innerHTML='';colEl.style.gap=GAP+'px';
  for(let x=0;x<lv.w;x++){
    const d=document.createElement('div');d.className='col-lbl';d.textContent=x;
    d.style.width=CELL_SIZE+'px';d.style.height='14px';colEl.appendChild(d);
  }

  const rowEl=document.getElementById('row-labels');
  rowEl.innerHTML='';rowEl.style.gap=GAP+'px';
  for(let y=0;y<lv.h;y++){
    const d=document.createElement('div');d.className='row-lbl';d.textContent=y;
    d.style.width='18px';d.style.height=CELL_SIZE+'px';rowEl.appendChild(d);
  }

  const grid=document.getElementById('game-grid');
  grid.innerHTML='';
  grid.style.gridTemplateColumns=`repeat(${lv.w},${CELL_SIZE}px)`;
  grid.style.gap=GAP+'px';

  const wrapper=document.getElementById('grid-wrapper');
  wrapper.style.width=(lv.w*(CELL_SIZE+GAP)-GAP)+'px';
  wrapper.style.height=(lv.h*(CELL_SIZE+GAP)-GAP)+'px';
  wrapper.className='grid-wrapper'+(showCoords?' show-coords':'');

  for(let y=0;y<lv.h;y++){
    for(let x=0;x<lv.w;x++){
      const cell=document.createElement('div');
      cell.className='grid-cell';cell.id=`c-${x}-${y}`;
      cell.dataset.coord=`${x},${y}`;
      cell.style.width=CELL_SIZE+'px';cell.style.height=CELL_SIZE+'px';
      renderCell(cell,mapState[y][x]);
      grid.appendChild(cell);
    }
  }

  for(let y=0;y<lv.h;y++)for(let x=0;x<lv.w;x++)
    if(lv.map[y][x]===2){playerPos={x,y};break;}

  initPlayerSprite();
}

function renderCell(cell,type){
  cell.innerHTML='';
  if(type===1)cell.innerHTML='<div class="ent-wall"><i class="fa-solid fa-xmark"></i></div>';
  else if(type===3)cell.innerHTML='<div class="ent-goal"></div>';
  else if(type===4)cell.innerHTML='<div class="ent-key"><i class="fa-solid fa-key"></i></div>';
  else if(type===5)cell.innerHTML='<div class="ent-door"><i class="fa-solid fa-lock"></i></div>';
  else if(type===6||type===7)cell.innerHTML='<div class="ent-portal"></div>';
  else if(type===8)cell.innerHTML='<div class="ent-frag"></div>';
}

function refreshCell(x,y){
  const cell=document.getElementById(`c-${x}-${y}`);
  if(cell)renderCell(cell,mapState[y][x]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER SPRITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPx(x){return x*(CELL_SIZE+GAP);}
function getPy(y){return y*(CELL_SIZE+GAP);}

function initPlayerSprite(){
  const sp=document.getElementById('player-sprite');
  sp.style.width=CELL_SIZE+'px';sp.style.height=CELL_SIZE+'px';
  sp.style.transition='none';
  sp.style.transform=`translate(${getPx(playerPos.x)}px,${getPy(playerPos.y)}px)`;
  sp.getBoundingClientRect();
  sp.style.transition=`transform ${MOVE_DUR}ms cubic-bezier(.25,.46,.45,.94)`;
  sp.classList.remove('shake');
}

function moveSpriteTo(x,y){
  const sp=document.getElementById('player-sprite');
  sp.classList.add('is-moving');
  sp.style.transform=`translate(${getPx(x)}px,${getPy(y)}px)`;
}

function spawnTrail(x,y){
  const wrapper=document.getElementById('grid-wrapper');
  const dot=document.createElement('div');dot.className='trail-dot';
  dot.style.left=getPx(x)+'px';dot.style.top=getPy(y)+'px';
  dot.style.width=CELL_SIZE+'px';dot.style.height=CELL_SIZE+'px';
  dot.style.borderRadius='2px';
  wrapper.appendChild(dot);
  setTimeout(()=>dot.remove(),1300);
}

function shakePlayer(){
  const sp=document.getElementById('player-sprite');
  const tx=getPx(playerPos.x),ty=getPy(playerPos.y);
  sp.style.setProperty('--tx',tx+'px');sp.style.setProperty('--ty',ty+'px');
  sp.classList.remove('shake');sp.getBoundingClientRect();
  sp.classList.add('shake');
  setTimeout(()=>sp.classList.remove('shake'),400);
}

function flashCell(x,y,cls){
  const cell=document.getElementById(`c-${x}-${y}`);
  if(!cell)return;
  cell.classList.remove(cls);cell.getBoundingClientRect();
  cell.classList.add(cls);setTimeout(()=>cell.classList.remove(cls),500);
}

function spawnWinParticles(x,y){
  const wrapper=document.getElementById('grid-wrapper');
  const cx=getPx(x)+CELL_SIZE/2,cy=getPy(y)+CELL_SIZE/2;
  const colors=['#FFD43B','#00F0FF','#00D26A','#fff','#FF8C42'];
  for(let i=0;i<18;i++){
    const p=document.createElement('div');p.className='win-particle';
    const angle=(i/18)*Math.PI*2;const dist=35+Math.random()*45;
    const color=colors[i%colors.length];
    p.style.cssText=`left:${cx}px;top:${cy}px;background:${color};--pdx:${Math.cos(angle)*dist}px;--pdy:${Math.sin(angle)*dist}px;box-shadow:0 0 6px ${color};`;
    wrapper.appendChild(p);setTimeout(()=>p.remove(),950);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE EXECUTION ‚Äî Real Python via Pyodide
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runCode(){
  if(isPlaying)return;
  if(!editor){log('Editor not ready.','e');return;}
  if(!currentLevel()){log('Select a difficulty first.','e');return;}
  if(!pyodide){log('Python engine not loaded yet. Please wait.','e');return;}

  // Reset state
  moveQueue=[];movesMade=0;
  mapState=currentLevel().map.map(r=>[...r]);
  inventory={keys:0,frags:0};
  movesLimit=movesLimitOrig;
  document.getElementById('h-keys').textContent='0';
  document.getElementById('h-frags').textContent='0';
  updateMoveCounter();
  renderGrid();

  const code=editor.getValue();
  const lv=currentLevel();

  if(!lv.reqRegex.test(code)){
    log('REJECTED: '+lv.reqText,'e');snd.error();return;
  }

  document.getElementById('run-btn').disabled=true;
  log('Running Python...','p');snd.start();

  if(window.innerWidth<=768)switchTab('grid');

  try {
    // Clear _move_log before running user code
    pyodide.runPython('_move_log.clear()');

    // Run the user's Python code
    await pyodide.runPythonAsync(code);

    // Read moves back from Python using .toJs() ‚Äî the correct Pyodide API
    // _move_log is a list of [direction, steps] lists
    const pyList = pyodide.globals.get('_move_log');
    const jsArray = pyList.toJs();   // converts Python list -> JS Array of JS Arrays
    pyList.destroy();

    moveQueue = jsArray.map(item => ({ d: item[0], s: item[1] }));

    if(moveQueue.length > 0) {
      await playQueue();
    } else {
      log('No agent.move() calls detected. Add: agent.move("right", 3)','w');
    }
  } catch(err) {
    // Show a clean Python error ‚Äî strip Pyodide stack noise
    let msg = err.message || String(err);
    const lines = msg.split('\n').map(l => l.trim()).filter(l => l);
    // Find the actual error line (last non-empty line)
    const lastLine = lines[lines.length - 1] || msg;
    log('Python error: ' + lastLine, 'e');
    snd.error();
  }

  document.getElementById('run-btn').disabled=false;
}

async function playQueue(){
  isPlaying=true;

  for(const mv of moveQueue){
    for(let i=0;i<mv.s;i++){
      if(movesLimit===0){
        log('MOVE LIMIT REACHED! Out of energy.','e');
        snd.crash();isPlaying=false;
        showCrash('Move limit reached! You ran out of energy. Optimize your route.');
        return;
      }

      await sleep(MOVE_DUR+20);
      const res=await processMove(mv.d);

      if(res==='crash'){isPlaying=false;document.getElementById('run-btn').disabled=false;return;}
      if(res==='win'){isPlaying=false;document.getElementById('run-btn').disabled=false;handleWin();return;}
    }
  }

  isPlaying=false;
  document.getElementById('player-sprite').classList.remove('is-moving');
  log('Protocol complete. Quantum Node not reached.','w');
}

async function processMove(dir){
  const dx=dir==='right'?1:dir==='left'?-1:0;
  const dy=dir==='down'?1:dir==='up'?-1:0;
  const nx=playerPos.x+dx,ny=playerPos.y+dy;
  const lv=currentLevel();

  if(nx<0||nx>=lv.w||ny<0||ny>=lv.h){
    flashCell(playerPos.x,playerPos.y,'wall-hit');
    shakePlayer();snd.error();
    showCrash('Agent hit the boundary wall. Out of bounds!');
    return'crash';
  }

  const tile=mapState[ny][nx];

  if(tile===1){
    flashCell(nx,ny,'wall-hit');shakePlayer();snd.crash();
    showCrash('Firewall collision! Agent systems critically damaged.');
    return'crash';
  }

  if(tile===5){
    if(inventory.keys>0){
      inventory.keys--;
      mapState[ny][nx]=0;
      document.getElementById('h-keys').textContent=inventory.keys;
      flashCell(nx,ny,'door-open');refreshCell(nx,ny);snd.unlock();
      log(`Door unlocked! Keys remaining: ${inventory.keys}`,'s');
    }else{
      flashCell(nx,ny,'wall-hit');shakePlayer();snd.crash();
      showCrash('Locked Door! You need a KEY to pass this barrier.');
      return'crash';
    }
  }

  spawnTrail(playerPos.x,playerPos.y);
  movesMade++;
  if(movesLimit>0)movesLimit--;
  updateMoveCounter();

  if(tile===6||tile===7){
    const targetType=tile===6?7:6;
    let tp=null;
    for(let y=0;y<lv.h&&!tp;y++)for(let x=0;x<lv.w&&!tp;x++)
      if(mapState[y][x]===targetType)tp={x,y};
    if(tp){
      flashCell(nx,ny,'warp-cell');snd.teleport();
      log(`Portal jump! Teleported to (${tp.x},${tp.y})`,'p');
      moveSpriteTo(nx,ny);playerPos={x:nx,y:ny};
      await sleep(MOVE_DUR+50);
      spawnTrail(nx,ny);
      moveSpriteTo(tp.x,tp.y);playerPos={x:tp.x,y:tp.y};
      return'ok';
    }
  }

  if(tile===4){
    inventory.keys++;mapState[ny][nx]=0;
    document.getElementById('h-keys').textContent=inventory.keys;
    flashCell(nx,ny,'key-pick');refreshCell(nx,ny);snd.collect();
    log(`KEY collected! Total keys: ${inventory.keys}`,'s');
  }

  if(tile===8){
    inventory.frags++;mapState[ny][nx]=0;
    document.getElementById('h-frags').textContent=inventory.frags;
    flashCell(nx,ny,'frag-pick');refreshCell(nx,ny);snd.collect();
    log(`Data fragment acquired! (${inventory.frags} total)`,'s');
  }

  moveSpriteTo(nx,ny);playerPos={x:nx,y:ny};
  if(tile===3)return'win';
  snd.move();
  return'ok';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIN / CRASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWin(){
  const lv=currentLevel();
  spawnWinParticles(playerPos.x,playerPos.y);snd.win();
  let totalFrags=0;
  for(let y=0;y<lv.h;y++)for(let x=0;x<lv.w;x++)if(lv.map[y][x]===8)totalFrags++;
  const stars=calcStars(movesMade,lv.optMoves,lv.reqRegex,editor.getValue(),inventory.frags,totalFrags);
  const xpGained=lv.xpBase+(stars*25)+(inventory.frags*15);
  totalXP+=xpGained;updateXPBar(xpGained);
  const key=diff+'_'+gLevelIdx;
  if(!bestScores[key]||movesMade<bestScores[key])bestScores[key]=movesMade;
  document.getElementById('h-best').textContent=bestScores[key];
  updateStarsDisplay(stars);
  const winStars=document.getElementById('win-stars').querySelectorAll('.ws');
  winStars.forEach((s,i)=>{s.classList.remove('on');if(i<stars)setTimeout(()=>s.classList.add('on'),i*200);});
  document.getElementById('ws-moves').textContent=movesMade;
  document.getElementById('ws-xp').textContent='+'+xpGained;
  document.getElementById('ws-frags').textContent=inventory.frags+'/'+totalFrags;
  log(`Layer cleared! ${xpGained} XP gained. Stars: ${'‚òÖ'.repeat(stars)}`,'s');
  setTimeout(()=>document.getElementById('modal-win').style.display='flex',700);
}

function calcStars(moves,optimal,regex,code,frags,totalFrags){
  let s=1;
  if(regex.test(code))s=2;
  if(moves<=Math.ceil(optimal*1.25)&&frags>=totalFrags)s=3;
  else if(moves<=Math.ceil(optimal*1.25))s=Math.max(s,2);
  return s;
}

function updateStarsDisplay(n){
  document.getElementById('stars-row').querySelectorAll('.star')
    .forEach((s,i)=>s.classList.toggle('on',i<n));
}

function nextLevel(){
  document.getElementById('modal-win').style.display='none';
  if(diff==='expert'){expertConceptIdx++;levelSet=[getExpertLevel()];}
  initLevel(gLevelIdx+1);snd.start();
}

function showCrash(msg){
  document.getElementById('crash-msg').textContent=msg;
  document.getElementById('modal-crash').style.display='flex';
}

function dismissCrash(){
  document.getElementById('modal-crash').style.display='none';
  resetLevel();
}

function resetLevel(){
  if(isPlaying)return;
  initLevel(gLevelIdx);snd.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCoords(){
  showCoords=!showCoords;
  document.getElementById('grid-wrapper').classList.toggle('show-coords',showCoords);
  document.getElementById('coord-btn').classList.toggle('on',showCoords);
}

function updateCodeStats(){
  if(!editor)return;
  const code=editor.getValue();
  const lines=code.split('\n').filter(l=>l.trim()&&!l.trim().startsWith('#')).length;
  const concepts=[];
  if(/def\s+\w+\(/.test(code))concepts.push('def');
  if(/for\s+\w+\s+in/.test(code))concepts.push('for');
  if(/while\s+/.test(code))concepts.push('while');
  if(/\[.*\]/.test(code))concepts.push('list');
  if(/[a-zA-Z_]\w*\s*=\s*\d/.test(code))concepts.push('var');
  document.getElementById('cs-lines').textContent=lines||'‚Äî';
  document.getElementById('cs-conc').textContent=concepts.length?concepts.join(', '):'‚Äî';
}

function log(msg,type=''){
  const term=document.getElementById('terminal');
  const div=document.createElement('div');div.className='tl';
  div.innerHTML=`<span class="tp">$</span><span class="tm ${type}">${msg}</span>`;
  term.appendChild(div);term.scrollTop=term.scrollHeight;
  while(term.children.length>35)term.removeChild(term.firstChild);
}

function switchTab(tab){
  document.getElementById('panel-grid').classList.toggle('active',tab==='grid');
  document.getElementById('panel-code').classList.toggle('active',tab==='code');
  document.getElementById('tab-grid').classList.toggle('active',tab==='grid');
  document.getElementById('tab-code').classList.toggle('active',tab==='code');
}

if(window.innerWidth<=768){
  document.getElementById('panel-grid').classList.add('active');
  document.getElementById('panel-code').classList.remove('active');
  document.getElementById('tab-grid').classList.add('active');
}else{
  document.getElementById('panel-grid').classList.add('active');
  document.getElementById('panel-code').classList.add('active');
}

window.addEventListener('resize',()=>{if(currentLevel&&currentLevel())renderGrid();});
</script>
</body>
</html>
